<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Imperio - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-width: 250px;
            --sidebar-collapsed: 70px;
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #ffd700;
            --success-color: #00d25b;
            --danger-color: #fc424a;
            --text-primary: #ffffff;
            --text-secondary: #8f9397;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Sidebar Styles - Looker Style */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 180px;
            background: #2d2d2d;
            z-index: 1000;
            border-right: 1px solid #404040;
        }

        .sidebar.collapsed {
            width: 180px;
        }

        .sidebar-header {
            padding: 20px 0;
            background: #2d2d2d;
        }
        
        .sidebar-title {
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
            padding: 0 15px;
            letter-spacing: 0.5px;
        }

        .sidebar-menu {
            padding: 0;
        }

        .menu-item {
            display: block;
            padding: 10px 15px;
            color: #b0b0b0;
            font-size: 12px;
            cursor: pointer;
            border-left: 3px solid transparent;
            font-weight: 500;
            text-decoration: none;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.05);
            color: #ffffff;
        }

        .menu-item.active {
            background: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            border-left-color: #4285f4;
        }

        /* Main Content */
        .main-content {
            margin-left: 180px;
            padding: 0;
            min-height: 100vh;
        }
        
        .main-content.table-mode {
            padding: 0;
        }
        
        .main-content.table-mode .page-header {
            display: none;
        }

        /* Header */
        .page-header {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .kpi-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .kpi-icon.success {
            background: rgba(0,210,91,0.2);
            color: var(--success-color);
        }

        .kpi-icon.danger {
            background: rgba(252,66,74,0.2);
            color: var(--danger-color);
        }

        .kpi-icon.warning {
            background: rgba(255,215,0,0.2);
            color: var(--accent-color);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .kpi-change {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .kpi-change.positive {
            color: var(--success-color);
        }

        .kpi-change.negative {
            color: var(--danger-color);
        }

        /* Two Column Tables Layout - Looker Style */
        .tables-container {
            display: flex;
            height: 100vh;
            background: #1a1a1a;
            gap: 1px;
            margin: 0;
            padding: 0;
        }
        
        #twoColumnView {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .table-column {
            flex: 1;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
        }
        
        .table-column:first-child {
            border-right: 1px solid #313131;
        }
        
        .table-header {
            background: #333333;
            padding: 15px 20px;
            border-bottom: 1px solid #404040;
        }
        
        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .header-left {
            text-align: center;
            flex: 1;
        }
        
        .date-filter {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 15px;
        }
        
        .date-input {
            background: #2d2d2d;
            border: 1px solid #404040;
            color: #ffffff;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            width: 130px;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #4285f4;
        }
        
        .filter-btn {
            background: #4285f4;
            border: none;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .filter-btn:hover {
            background: #3367d6;
        }
        
        .table-header h3 {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .table-subtitle {
            font-size: 10px;
            color: #9aa0a6;
            font-weight: 400;
        }
        
        .table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Data Tables */
        .data-table-container {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        .data-table thead {
            background: #333333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 500;
            color: #e8eaed;
            border-bottom: 1px solid #404040;
            font-size: 10px;
        }

        .data-table td {
            padding: 8px 8px;
            border-bottom: 1px solid #2d2d2d;
            color: #e8eaed;
            font-size: 10px;
            white-space: nowrap;
        }

        .data-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tbody tr:hover {
            background: rgba(66, 133, 244, 0.05);
        }
        
        .loading-cell {
            text-align: center;
            padding: 40px !important;
            color: #9aa0a6;
            font-style: italic;
        }
        
        .currency {
            text-align: right;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 10px;
        }
        
        .datetime {
            color: #9aa0a6;
            font-size: 9px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .roi-excellent { 
            color: #34a853; 
            font-weight: 600;
            background: rgba(52, 168, 83, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .roi-good { 
            color: #fbbc04; 
            font-weight: 600;
            background: rgba(251, 188, 4, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .roi-attention { 
            color: #ea4335; 
            font-weight: 600;
            background: rgba(234, 67, 53, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        .status-excellent { background-color: #34a853; }
        .status-good { background-color: #fbbc04; }
        .status-attention { background-color: #ea4335; }

        .roi-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .roi-badge.high {
            background: rgba(0,210,91,0.2);
            color: var(--success-color);
        }

        .roi-badge.medium {
            background: rgba(255,215,0,0.2);
            color: var(--accent-color);
        }

        .roi-badge.low {
            background: rgba(252,66,74,0.2);
            color: var(--danger-color);
        }

        /* Charts Container */
        .chart-container {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .chart-header {
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Dashboard de Or√ßamento Styles */
        #orcamentoDashboard {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 8px 0;
        }

        .dashboard-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-title {
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-item i {
            margin-right: 8px;
            width: 16px;
        }

        .text-success { color: #28a745 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-info { color: #17a2b8 !important; }

        /* CORRE√á√ÉO FINAL DAS TABELAS - ALINHAMENTO PERFEITO */
        .data-table td:nth-child(1) { 
            width: 35% !important; 
            text-align: left !important; 
            padding: 10px !important; 
        }
        .data-table td:nth-child(2) { 
            width: 18% !important; 
            text-align: center !important; 
            padding: 10px !important; 
            color: #FFD700 !important;
            font-weight: bold !important;
        }
        .data-table td:nth-child(3) { 
            width: 18% !important; 
            text-align: center !important; 
            padding: 10px !important; 
            color: #FFD700 !important;
            font-weight: bold !important;
        }
        .data-table td:nth-child(4) { 
            width: 19% !important; 
            text-align: center !important; 
            padding: 10px !important; 
        }
        .data-table td:nth-child(5) { 
            width: 10% !important; 
            text-align: center !important; 
            padding: 10px !important; 
        }

        /* Efeitos do Logo Imp√©rio e Hora do Pix */
        #imperio-logo {
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
            animation: logoGlow 3s ease-in-out infinite;
        }

        #imperio-logo:hover {
            transform: scale(1.1) translateY(-3px);
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.4)) brightness(1.15);
            cursor: pointer;
        }

        @keyframes logoGlow {
            0%, 100% {
                filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
            }
            50% {
                filter: drop-shadow(0 4px 16px rgba(255, 255, 255, 0.5)) drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
            }
        }

        /* Efeito hover OracleSys discreto */
        .sidebar div a[href="/oraclesys"]:hover {
            color: rgba(255,215,0,0.9) !important;
            transform: translateY(-1px);
        }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="text-align: center; padding: 20px 0;">
                <img src="/static/logo.png" alt="Imp√©rio Logo" id="imperio-logo" style="max-width: 120px; height: auto; transition: all 0.3s ease;">
            </div>
        </div>
        <div class="sidebar-menu">
            <a href="#orcamento" class="menu-item active" data-view="orcamento">Or√ßamento Atual</a>
            <a href="#geral" class="menu-item" data-view="geral">ROI (Geral)</a>
            <a href="#perfil" class="menu-item" data-view="perfil">ROI (Perfil)</a>
            <a href="#grupos" class="menu-item" data-view="grupos">ROI (Grupo)</a>
            <a href="#horapix" class="menu-item" data-view="horapix">
                <i class="fas fa-clock" style="margin-right: 8px;"></i>Hora do Pix
            </a>
            <a href="#acaoprincipal" class="menu-item" data-view="acaoprincipal">
                <i class="fas fa-trophy" style="margin-right: 8px;"></i>A√ß√£o Principal
            </a>
        </div>
        
        <!-- Rodap√© com link OracleSys discreto -->
        <div style="position: absolute; bottom: 15px; left: 0; right: 0; text-align: center;">
            <a href="/oraclesys" target="_blank" style="color: rgba(255,215,0,0.6); text-decoration: none; font-size: 0.75rem; transition: color 0.3s ease;">
                <i class="fas fa-crown" style="font-size: 0.7rem; margin-right: 3px;"></i>
                <span>OracleSys</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">

        <!-- Content Container -->
        <div id="contentContainer">
            <!-- Dashboard de Or√ßamento EXATO da Screenshot -->
            <div id="orcamentoDashboard" style="display: block;">
                <!-- Header da P√°gina com Controles -->
                <div class="page-header" style="background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 style="color: white; margin-bottom: 5px; font-weight: 600;">
                                <i class="fas fa-calendar-check"></i> Monitoramento Di√°rio
                            </h2>
                            <div style="color: rgba(255,255,255,0.8); margin-bottom: 0; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-database"></i>
                                <span>Produto ID:</span>
                                <input type="text" id="productIdInput" value="68ff78f80d0e097d617d472b"
                                       placeholder="Digite o ID do produto..."
                                       style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; width: 300px; font-family: monospace;">
                                <button onclick="changeProduct()" style="background: #28a745; border: 1px solid #28a745; color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-save"></i> Salvar
                                </button>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group">
                                <button class="btn btn-light" onclick="executeCollectionNow()" id="coletarAgoraBtn">
                                    <i class="fas fa-sync"></i> Coletar Agora
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Status Line -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <div class="d-flex align-items-center text-white">
                            <div class="status-indicator" style="width: 10px; height: 10px; background: #00ff00; border-radius: 50%; margin-right: 10px; animation: pulse 2s infinite;"></div>
                            <span><strong>Status:</strong> Sistema Ativo</span>
                            <span style="margin-left: 20px;" id="lastCollectionInfo">√öltima coleta: --</span>
                            <span style="margin-left: 20px;" id="collectionsToday">Coletas hoje: 0</span>
                            <span style="margin-left: 20px;" id="calculationPeriod">Dados cumulativos de hoje (00:00 at√© agora)</span>
                        </div>
                    </div>
                </div>

                <!-- Cards Principais (4 cards como na screenshot) -->
                <div class="row g-3 mb-4">
                    <!-- ROI Card -->
                    <div class="col-lg-3 col-md-6">
                        <div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border-radius: 15px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(155,89,182,0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.1;">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div style="position: relative; z-index: 2;">
                                <div style="font-size: 3rem; font-weight: bold; margin: 10px 0;" id="roiGeral">--</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ROI Geral</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vendas Card -->
                    <div class="col-lg-3 col-md-6">
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 15px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(52,152,219,0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.1;">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div style="position: relative; z-index: 2;">
                                <div style="font-size: 2.2rem; font-weight: bold; margin: 10px 0;" id="vendasHoje">R$ --</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Vendas Hoje</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gastos Card -->
                    <div class="col-lg-3 col-md-6">
                        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border-radius: 15px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(231,76,60,0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.1;">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div style="position: relative; z-index: 2;">
                                <div style="font-size: 2.2rem; font-weight: bold; margin: 10px 0;" id="gastosHoje">R$ --</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Gastos Hoje</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lucro Card -->
                    <div class="col-lg-3 col-md-6">
                        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); border-radius: 15px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(39,174,96,0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.1;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div style="position: relative; z-index: 2;">
                                <div style="font-size: 2.2rem; font-weight: bold; margin: 10px 0;" id="lucroHoje">R$ --</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Lucro Hoje</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards de Canais (3 cards como na screenshot) -->
                <div class="row g-3 mb-4">
                    <!-- Canal Geral -->
                    <div class="col-md-4">
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; padding: 20px; color: white; position: relative;">
                            <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 0.7rem;" id="orcamentoGeral">
                                R$ --
                            </div>
                            <div style="margin-bottom: 15px;">
                                <i class="fas fa-globe" style="margin-right: 8px;"></i>
                                <strong>Canal Geral</strong>
                            </div>
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 2.5rem; font-weight: bold;" id="roiGeral2">--</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ROI do Canal</div>
                            </div>
                            <div style="display: flex; justify-content: space-around; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Vendas</div>
                                    <div style="font-weight: bold;" id="vendasGeral">R$ --</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Gastos</div>
                                    <div style="font-weight: bold;" id="gastosGeral">R$ --</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Lucro</div>
                                    <div style="font-weight: bold;" id="lucroGeral">R$ --</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instagram -->
                    <div class="col-md-4">
                        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); border-radius: 12px; padding: 20px; color: white; position: relative;">
                            <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 0.7rem;" id="orcamentoInstagram">
                                R$ --
                            </div>
                            <div style="margin-bottom: 15px;">
                                <i class="fab fa-instagram" style="margin-right: 8px;"></i>
                                <strong>Instagram</strong>
                            </div>
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 2.5rem; font-weight: bold;" id="roiInstagram">--</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ROI do Canal</div>
                            </div>
                            <div style="display: flex; justify-content: space-around; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Vendas</div>
                                    <div style="font-weight: bold;" id="vendasInstagram">R$ --</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Gastos</div>
                                    <div style="font-weight: bold;" id="gastosInstagram">R$ --</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Lucro</div>
                                    <div style="font-weight: bold;" id="lucroInstagram">R$ --</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grupos -->
                    <div class="col-md-4">
                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); border-radius: 12px; padding: 20px; color: white; position: relative;">
                            <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 0.7rem;" id="orcamentoGrupos">
                                R$ --
                            </div>
                            <div style="margin-bottom: 15px;">
                                <i class="fas fa-users" style="margin-right: 8px;"></i>
                                <strong>Grupos</strong>
                            </div>
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 2.5rem; font-weight: bold;" id="roiGrupos">--</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ROI do Canal</div>
                            </div>
                            <div style="display: flex; justify-content: space-around; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Vendas</div>
                                    <div style="font-weight: bold;" id="vendasGrupos">R$ --</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Gastos</div>
                                    <div style="font-weight: bold;" id="gastosGrupos">R$ --</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Lucro</div>
                                    <div style="font-weight: bold;" id="lucroGrupos">R$ --</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Looker-style Two Column Tables -->
            <div id="twoColumnView" style="display: none;">
                <div class="tables-container">
                    <!-- Coluna Esquerda: Dados Cumulativos -->
                    <div class="table-column">
                        <div class="table-header" style="text-align: center;">
                            <h3 id="leftColumnTitle">Data e Hora ‚Üì</h3>
                            <div class="table-subtitle" id="leftColumnSubtitle">Valor Usado | Vendas | ROI (Cumulativo)</div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table" style="width:100%; table-layout:fixed; border-collapse:collapse;">
                                <thead>
                                    <tr>
                                        <th style="width:35%; text-align:left; padding:10px; background:#333;">Data e Hora</th>
                                        <th style="width:18%; text-align:center; padding:10px; background:#333;">Valor Usado</th>
                                        <th style="width:18%; text-align:center; padding:10px; background:#333;">Vendas</th>
                                        <th style="width:19%; text-align:center; padding:10px; background:#333;">ROI</th>
                                        <th style="width:10%; text-align:center; padding:10px; background:#333;">‚óè</th>
                                    </tr>
                                </thead>
                                <tbody id="cumulativeData">
                                    <tr><td colspan="5" class="loading-cell">Carregando dados cumulativos...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Coluna Direita: Dados por Intervalo -->
                    <div class="table-column">
                        <div class="table-header" style="text-align: center;">
                            <h3 id="rightColumnTitle">Data e Hora ‚Üì</h3>
                            <div class="table-subtitle" id="rightColumnSubtitle">Valor Usado | Vendas | ROI (√öltima Faixa 30min)</div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table" style="width:100%; table-layout:fixed; border-collapse:collapse;">
                                <thead>
                                    <tr>
                                        <th style="width:35%; text-align:left; padding:10px; background:#333;">Data e Hora</th>
                                        <th style="width:18%; text-align:center; padding:10px; background:#333;">Valor Usado</th>
                                        <th style="width:18%; text-align:center; padding:10px; background:#333;">Vendas</th>
                                        <th style="width:19%; text-align:center; padding:10px; background:#333;">ROI</th>
                                        <th style="width:10%; text-align:center; padding:10px; background:#333;">‚óè</th>
                                    </tr>
                                </thead>
                                <tbody id="intervalData">
                                    <tr><td colspan="5" class="loading-cell">Carregando dados da faixa...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HORA DO PIX VIEW - DARK THEME -->
            <div id="horaPixView" style="display: none;">
                <div style="padding: 15px;">

                    <!-- KPIs Compactos (8 cards) -->
                    <div class="row g-2 mb-3">
                        <!-- FINALIZADOS (4 cards azuis) -->
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #4C6EF5 0%, #5C7CFA 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üîµ FINALIZADOS</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiFinalizadosCount">0</div>
                                <div style="font-size: 10px; opacity: 0.8;">Sorteios</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #4C6EF5 0%, #5C7CFA 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üí∞ RECEITA</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiFinalizadosReceita">R$ 0</div>
                                <div style="font-size: 10px; opacity: 0.8;">Realizado</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #4C6EF5 0%, #5C7CFA 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üí∏ PR√äMIOS + TAXA</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiFinalizadosCustos">R$ 0</div>
                                <div style="font-size: 10px; opacity: 0.8;">Pagos</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #4C6EF5 0%, #5C7CFA 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üíö LUCRO</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiFinalizadosLucro">R$ 0</div>
                                <div style="font-size: 10px; opacity: 0.8;" id="kpiFinalizadosMargin">Margem: 0%</div>
                            </div>
                        </div>

                        <!-- ATIVOS (4 cards verdes) -->
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #51CF66 0%, #69DB7C 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üü¢ ATIVOS</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiAtivosCount">0</div>
                                <div style="font-size: 10px; opacity: 0.8;">Em Andamento</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #51CF66 0%, #69DB7C 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üí∞ RECEITA</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiAtivosReceita">R$ 0</div>
                                <div style="font-size: 10px; opacity: 0.8;">Parcial</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #51CF66 0%, #69DB7C 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üí∏ PR√äMIOS + TAXA</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiAtivosCustos">R$ 0</div>
                                <div style="font-size: 10px; opacity: 0.8;">Previstos</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div style="background: linear-gradient(135deg, #51CF66 0%, #69DB7C 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">‚ö†Ô∏è LUCRO</div>
                                <div style="font-size: 22px; font-weight: bold;" id="kpiAtivosLucro">R$ 0</div>
                                <div style="font-size: 10px; opacity: 0.8;">Projetado</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs Dark Theme (APENAS 2) -->
                    <div style="margin-bottom: 15px;">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="tabHoraPixMonitoramento" onclick="switchHoraPixTab('monitoramento')" style="border-color: #00D9FF; color: #00D9FF;">
                                <i class="fas fa-list"></i> Monitoramento <span class="badge bg-info ms-1" id="badgeHoraPixTotal">0</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="tabHoraPixEstatisticas" onclick="switchHoraPixTab('estatisticas')" style="border-color: #00D9FF; color: #00D9FF;">
                                <i class="fas fa-chart-bar"></i> Estat√≠sticas
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div id="horaPixTabContent">
                        <!-- MONITORAMENTO TAB (Ativos + Finalizados) -->
                        <div id="horaPixMonitoramentoContent" style="display: block;">
                            <!-- Tabela Ativos -->
                            <div style="margin-bottom: 20px;">
                                <h6 style="color: #51CF66; margin-bottom: 10px;">
                                    <i class="fas fa-play-circle"></i> SORTEIOS ATIVOS
                                    <span class="badge bg-success ms-2" id="badgeHoraPixActive">0</span>
                                </h6>
                                <div style="background: #1a1a1a; border-radius: 10px; padding: 10px;">
                                    <table class="table table-dark table-hover" style="margin: 0; font-size: 12px;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid #51CF66;">
                                                <th style="color: #51CF66; width: 35%;">Sorteio</th>
                                                <th style="color: #51CF66; text-align: center;">Status</th>
                                                <th style="color: #51CF66; text-align: right;">Pr√™mio</th>
                                                <th style="color: #51CF66; text-align: right;">Receita</th>
                                                <th style="color: #51CF66; text-align: right;">Taxa 3%</th>
                                                <th style="color: #51CF66; text-align: right;">Lucro</th>
                                                <th style="color: #51CF66; text-align: right;">ROI</th>
                                            </tr>
                                        </thead>
                                        <tbody id="horaPixAtivasList">
                                            <tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Carregando...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Espa√ßamento Din√¢mico -->
                            <div id="horaPixSpacer" style="height: 30px;"></div>

                            <!-- Tabela Finalizados -->
                            <div>
                                <h6 style="color: #4C6EF5; margin-bottom: 10px;">
                                    <i class="fas fa-check-circle"></i> SORTEIOS FINALIZADOS
                                    <span class="badge bg-primary ms-2" id="badgeHoraPixFinished">0</span>
                                </h6>
                                <div style="background: #1a1a1a; border-radius: 10px; padding: 10px;">
                                    <table class="table table-dark table-hover" style="margin: 0; font-size: 12px;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid #4C6EF5;">
                                                <th style="color: #4C6EF5; width: 35%;">Sorteio</th>
                                                <th style="color: #4C6EF5; text-align: center;">Status</th>
                                                <th style="color: #4C6EF5; text-align: right;">Pr√™mio</th>
                                                <th style="color: #4C6EF5; text-align: right;">Receita</th>
                                                <th style="color: #4C6EF5; text-align: right;">Taxa 3%</th>
                                                <th style="color: #4C6EF5; text-align: right;">Lucro</th>
                                                <th style="color: #4C6EF5; text-align: right;">Margem</th>
                                            </tr>
                                        </thead>
                                        <tbody id="horaPixFinalizadasList">
                                            <tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Carregando...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ESTAT√çSTICAS TAB -->
                        <div id="horaPixEstatisticasContent" style="display: none;">
                            <div class="row g-3">
                                <!-- Gr√°fico Principal (COM MAX-HEIGHT PARA EVITAR EXPANS√ÉO INFINITA) -->
                                <div class="col-12">
                                    <div style="background: #1a1a1a; border-radius: 10px; padding: 20px; border: 1px solid #333;">
                                        <h6 style="color: #00D9FF; margin-bottom: 15px;"><i class="fas fa-chart-line"></i> Performance dos Sorteios</h6>
                                        <div style="position: relative; height: 400px; max-height: 400px;">
                                            <canvas id="horaPixChart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Top Compradores e Regi√µes -->
                                <div class="col-md-6">
                                    <div style="background: #1a1a1a; border-radius: 10px; padding: 20px; border: 1px solid #333;">
                                        <h6 style="color: #00D9FF; margin-bottom: 15px;"><i class="fas fa-users"></i> Top 10 Compradores</h6>
                                        <div id="topCompradores" style="max-height: 300px; overflow-y: auto;">
                                            <p style="color: #666; text-align: center; padding: 20px;">Selecione um sorteio para ver detalhes</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div style="background: #1a1a1a; border-radius: 10px; padding: 20px; border: 1px solid #333;">
                                        <h6 style="color: #00D9FF; margin-bottom: 15px;"><i class="fas fa-map-marker-alt"></i> Top 10 Regi√µes</h6>
                                        <div id="topRegioes" style="max-height: 300px; overflow-y: auto;">
                                            <p style="color: #666; text-align: center; padding: 20px;">Selecione um sorteio para ver detalhes</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- A√á√ÉO PRINCIPAL VIEW -->
            {% include '_main_action_section.html' %}

        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Inline JavaScript functions for immediate availability
        
        // Get today's date in Brazilian format (DD/MM/YYYY) for filtering
        function getTodayBrazilianFormat() {
            // Usar timezone do Brasil para garantir data correta
            const today = new Date();
            // Ajustar para timezone brasileiro (UTC-3)
            const brazilOffset = -3 * 60; // minutos
            const utc = today.getTime() + (today.getTimezoneOffset() * 60000);
            const brazilTime = new Date(utc + (brazilOffset * 60000));
            
            const day = brazilTime.getDate().toString().padStart(2, '0');
            const month = (brazilTime.getMonth() + 1).toString().padStart(2, '0');
            const year = brazilTime.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Mock data using TODAY's date
        function getMockDataForToday() {
            const todayBR = getTodayBrazilianFormat(); // Gets current system date in DD/MM/YYYY
            
            return {
                cumulative: [
                    { dateTime: `${todayBR} 09:30:00`, valorUsado: 1200.00, vendas: 2800.00, roi: 2.33 },
                    { dateTime: `${todayBR} 10:15:00`, valorUsado: 1580.50, vendas: 3420.80, roi: 2.16 },
                    { dateTime: `${todayBR} 11:00:00`, valorUsado: 2059.19, vendas: 4524.84, roi: 2.20 },
                    { dateTime: `${todayBR} 11:30:00`, valorUsado: 2350.75, vendas: 5120.40, roi: 2.18 }
                ],
                interval: [
                    { dateTime: `${todayBR} 09:00:00 √†s 09:30:00`, valorUsado: 180.25, vendas: 420.15, roi: 2.33 },
                    { dateTime: `${todayBR} 09:30:00 √†s 10:00:00`, valorUsado: 200.50, vendas: 380.30, roi: 1.90 },
                    { dateTime: `${todayBR} 10:00:00 √†s 10:30:00`, valorUsado: 239.51, vendas: 620.80, roi: 2.59 },
                    { dateTime: `${todayBR} 10:30:00 √†s 11:00:00`, valorUsado: 291.25, vendas: 695.60, roi: 2.39 }
                ]
            };
        }
        
        // Utility functions
        function formatCurrency(value) {
            if (!value || isNaN(value)) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        
        function formatROI(roi) {
            if (!roi || isNaN(roi)) return '0.00';
            return parseFloat(roi).toFixed(2);
        }
        
        function getROIClass(roi) {
            const value = parseFloat(roi) || 0;
            if (value >= 2.0) return 'roi-excellent';
            if (value >= 1.0) return 'roi-good';
            return 'roi-attention';
        }
        
        function getStatusDot(roi) {
            const value = parseFloat(roi) || 0;
            let statusClass = 'status-attention';
            if (value >= 2.0) statusClass = 'status-excellent';
            else if (value >= 1.0) statusClass = 'status-good';
            return `<span class="status-dot ${statusClass}"></span>`;
        }
        
        // Main functions
        function populateTable(tableId, data) {
            console.log('Populating table:', tableId, 'with', data.length, 'items');
            const tbody = document.getElementById(tableId);
            
            if (!tbody) {
                console.error('Table element not found:', tableId);
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading-cell">Nenhum dado dispon√≠vel</td></tr>';
                return;
            }
            
            // Sort data chronologically (oldest first, most recent last/bottom)
            const sortedData = [...data].sort((a, b) => {
                // Convert date from DD/MM/YYYY HH:mm:ss to comparable format
                const parseDate = (dateStr) => {
                    try {
                        // Handle both simple dates and date ranges (with "√†s")
                        const cleanDate = dateStr.split(' √†s ')[0]; // Take first part if range
                        const [datePart, timePart] = cleanDate.split(' ');
                        const [day, month, year] = datePart.split('/');
                        const fullDate = `${year}-${month}-${day} ${timePart || '00:00:00'}`;
                        return new Date(fullDate);
                    } catch (e) {
                        return new Date(0); // Default to epoch if parsing fails
                    }
                };
                
                const dateA = parseDate(a.dateTime);
                const dateB = parseDate(b.dateTime);
                return dateA - dateB; // Ascending order (oldest to newest)
            });
            
            console.log('Data sorted chronologically (oldest first):', sortedData.length, 'items');
            
            let html = '';
            sortedData.forEach(row => {
                html += `
                    <tr>
                        <td class="datetime">${row.dateTime}</td>
                        <td class="currency">${formatCurrency(row.valorUsado)}</td>
                        <td class="currency">${formatCurrency(row.vendas)}</td>
                        <td><span class="${getROIClass(row.roi)}">${formatROI(row.roi)}</span></td>
                        <td>${getStatusDot(row.roi)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            console.log('Table', tableId, 'populated successfully');
        }
        
        function loadAllTableData() {
            console.log('Loading all table data...');
            const todayMockData = getMockDataForToday();
            populateTable('cumulativeData', todayMockData.cumulative);
            populateTable('intervalData', todayMockData.interval);
            console.log('All tables loaded!');
        }
        
        // Button handlers
        function handleApplyFilter() {
            console.log('Apply filter clicked');
            const dateInput = document.getElementById('dateFilter');
            if (!dateInput || !dateInput.value) {
                alert('Selecione uma data primeiro');
                return;
            }
            
            const selectedDate = dateInput.value;
            const [year, month, day] = selectedDate.split('-');
            const targetDate = `${day}/${month}/${year}`;
            
            console.log('Filtering by date:', targetDate);
            
            // Use API data if available, otherwise use mock data for TODAY
            const todayMockData = getMockDataForToday();
            const dataSource = currentAPIData || {
                cumulativeData: todayMockData.cumulative,
                intervalData: todayMockData.interval
            };
            
            console.log('üéØ FILTRANDO DADOS POR DATA:', targetDate);
            console.log('üìä Dados dispon√≠veis antes do filtro:');
            console.log('   - Cumulativo:', dataSource.cumulativeData?.length || 0);
            console.log('   - Intervalo:', dataSource.intervalData?.length || 0);
            
            const filteredCumulative = (dataSource.cumulativeData || []).filter(row => 
                row.dateTime && row.dateTime.includes(targetDate)
            );
            const filteredInterval = (dataSource.intervalData || []).filter(row => 
                row.dateTime && row.dateTime.includes(targetDate)
            );
            
            console.log('üìä Dados encontrados ap√≥s filtro:');
            console.log('   - Cumulativo:', filteredCumulative.length);
            console.log('   - Intervalo:', filteredInterval.length);
            
            if (filteredCumulative.length === 0 && filteredInterval.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum dado encontrado para a data especificada');
                alert(`Nenhum dado encontrado para a data ${targetDate}. Mostrando todos os dados dispon√≠veis.`);
                // Mostrar todos os dados se n√£o encontrar nenhum para a data espec√≠fica
                populateTable('cumulativeData', dataSource.cumulativeData || []);
                populateTable('intervalData', dataSource.intervalData || []);
            } else {
                console.log('‚úÖ Mostrando dados filtrados para a data:', targetDate);
                populateTable('cumulativeData', filteredCumulative);
                populateTable('intervalData', filteredInterval);
            }
        }
        
        function handleClearFilter() {
            console.log('üîÑ Clear filter clicked - mostrando TODOS os dados REAIS');
            // Reset to current system date (TODAY) but don't auto-filter
            ensureTodayDate();
            // Reload data for current view WITHOUT auto-filter (show all real data)
            if (currentView === 'orcamento') {
                loadDashboardData();
            } else {
                loadAPIData(currentView, false);
            }
        }
        
        function handleForceLoad() {
            console.log('‚ö° Force load clicked - carregando TODOS os dados REAIS');
            // Always ensure we have today's date
            ensureTodayDate();
            // Force reload data for current view WITHOUT auto-filter (show all real data)
            if (currentView === 'orcamento') {
                loadDashboardData();
            } else {
                loadAPIData(currentView, false);
            }
        }
        
        // API data loading
        let currentAPIData = null;
        let currentView = 'geral';
        
        // Ensure date input is always set to TODAY (current system date)
        function ensureTodayDate() {
            const dateInput = document.getElementById('dateFilter');
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            
            if (dateInput) {
                // Always set to today's date, regardless of what was there before
                dateInput.value = today;
                console.log('Date input set to TODAY:', today);
            } else {
                console.error('Date input element not found!');
            }
        }
        
        async function loadAPIData(view, autoFilterToday = false) {
            console.log('\n=== LOADING API DATA ===');
            console.log('View:', view, '| Auto-filter today:', autoFilterToday);
            
            // Always ensure today's date is set
            ensureTodayDate();
            
            try {
                // Special handling for orcamento view - use different endpoint
                const url = view === 'orcamento' ? '/api/imperio/orcamento/dashboard' : `/api/imperio/looker/${view}`;
                console.log('Fetching URL:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API SUCCESS - Received data for', view);
                
                // Handle different data formats for orcamento vs looker views
                if (view === 'orcamento') {
                    console.log('üìä Dashboard data received - status:', data.status);
                    console.log('üìä Historico coletas:', (data.historico_coletas || []).length, 'items');
                    
                    // For orcamento view, the dashboard is handled separately
                    // This loadAPIData is called but orcamento uses loadDashboardData instead
                    console.log('‚ö†Ô∏è Orcamento view should use loadDashboardData, not loadAPIData');
                    return data;
                } else {
                    console.log('- cumulativeData:', (data.cumulativeData || []).length, 'items');
                    console.log('- intervalData:', (data.intervalData || []).length, 'items');
                    console.log('- dateRange:', data.dateRange || 'N/A');
                }
                
                // Store the data
                currentAPIData = data;
                
                // APLICAR FILTRO INTELIGENTE POR DATA ATUAL (only for looker views)
                if (view !== 'orcamento') {
                    const todayBR = getTodayBrazilianFormat();
                    console.log('üéØ APLICANDO FILTRO AUTOM√ÅTICO PARA DATA:', todayBR);
                    console.log('üìä Dados cumulativos totais:', data.cumulativeData?.length || 0);
                    console.log('üìä Dados intervalos totais:', data.intervalData?.length || 0);
                    
                    // Filtrar dados para data atual
                    const todayCumulative = (data.cumulativeData || []).filter(row => 
                        row.dateTime && row.dateTime.includes(todayBR)
                    );
                    const todayInterval = (data.intervalData || []).filter(row => 
                        row.dateTime && row.dateTime.includes(todayBR)
                    );
                    
                    console.log('üìä Dados de HOJE - Cumulativo:', todayCumulative.length);
                    console.log('üìä Dados de HOJE - Intervalo:', todayInterval.length);
                    
                    // Se n√£o temos dados de hoje, mostrar os mais recentes
                    if (todayCumulative.length === 0 && todayInterval.length === 0) {
                        console.log('‚ö†Ô∏è Sem dados para hoje, mostrando todos os dados dispon√≠veis');
                        populateTable('cumulativeData', data.cumulativeData || []);
                        populateTable('intervalData', data.intervalData || []);
                    } else {
                        console.log('‚úÖ Mostrando dados filtrados para HOJE');
                        populateTable('cumulativeData', todayCumulative);
                        populateTable('intervalData', todayInterval);
                    }
                }
                
                console.log('=== API DATA LOADED SUCCESSFULLY ===\n');
                return data;
                
            } catch (error) {
                console.error('\nAPI FAILED for', view, ':', error.message);
                console.log('Using mock data as fallback...');
                
                const todayMockData = getMockDataForToday();
                console.log('Mock data generated:', todayMockData.cumulative.length, 'cumulative,', todayMockData.interval.length, 'interval');
                
                populateTable('cumulativeData', todayMockData.cumulative);
                populateTable('intervalData', todayMockData.interval);
                
                console.log('=== FALLBACK DATA LOADED ===\n');
                return null;
            }
        }
        
        // Navigation setup (com prote√ß√£o contra listeners duplicados)
        let navigationSetup = false;
        function setupNavigation() {
            if (navigationSetup) {
                console.log('Navigation already setup, skipping duplicate setup');
                return;
            }
            
            console.log('Setting up navigation');
            const menuItems = document.querySelectorAll('.menu-item[data-view]');
            
            menuItems.forEach(item => {
                if (item && item.addEventListener) {
                    // Remove any existing listeners first
                    item.removeEventListener('click', handleMenuClick);
                    // Add the new listener
                    item.addEventListener('click', handleMenuClick);
                }
            });
            
            navigationSetup = true;
            console.log('Navigation setup completed');
        }
        
        // Separate function to handle menu clicks (easier to remove/add)
        function handleMenuClick(e) {
            e.preventDefault();
            const view = this.getAttribute('data-view');
            console.log('Menu clicked:', view);
            
            // Update active menu item
            const menuItems = document.querySelectorAll('.menu-item[data-view]');
            menuItems.forEach(mi => mi.classList.remove('active'));
            this.classList.add('active');
            
            // Update URL hash
            window.location.hash = view;
            
            // Update current view
            currentView = view;

            // Handle different view types
            if (view === 'orcamento') {
                // Show dashboard view, hide table view
                showDashboardView();
                loadDashboardData();
            } else if (view === 'horapix') {
                // Show Hora do Pix view (j√° carrega dados automaticamente)
                showHoraPixView();
            } else if (view === 'acaoprincipal') {
                // Show A√ß√£o Principal view
                showMainActionView();
            } else {
                // Show table view, hide dashboard view
                showTableView();

                // Update column titles
                updateColumnTitles(view);

                // Ensure date is set
                ensureTodayDate();

                // Load API data for this view (WITHOUT auto-filter - show all real data)
                // Skip loadAPIData for orcamento and horapix as they're handled separately
                if (view !== 'orcamento' && view !== 'horapix') {
                    loadAPIData(view, false);
                }
            }
        }
        
        // Handle hash changes (APENAS atualiza UI - sem recarregar dados)
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.substring(1);
            if (hash && ['orcamento', 'geral', 'perfil', 'grupos', 'horapix'].includes(hash)) {
                updateActiveMenuItem(hash);
                currentView = hash;

                if (hash === 'orcamento') {
                    showDashboardView();
                    // loadDashboardData(); - REMOVIDO para evitar loop
                } else if (hash === 'horapix') {
                    showHoraPixView();
                    // loadHoraPixData(); - REMOVIDO para evitar loop
                } else if (hash === 'acaoprincipal') {
                    showMainActionView();
                } else {
                    showTableView();
                    updateColumnTitles(hash);
                    ensureTodayDate();
                    // loadAPIData(hash, false); - REMOVIDO para evitar loop
                }
            }
        });
        
        function updateActiveMenuItem(view) {
            const menuItems = document.querySelectorAll('.menu-item[data-view]');
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-view') === view) {
                    item.classList.add('active');
                }
            });
        }
        
        function updateColumnTitles(view) {
            const titles = {
                'geral': {
                    leftTitle: 'Data e Hora ‚Üì',
                    leftSubtitle: 'Valor Usado | Vendas | ROI (Cumulativo)',
                    rightTitle: 'Data e Hora ‚Üì',
                    rightSubtitle: 'Valor Usado | Vendas | ROI (√öltima Faixa 30min)'
                },
                'perfil': {
                    leftTitle: 'Data e Hora ‚Üì',
                    leftSubtitle: 'Valor Usado | Vendas | ROI (Instagram Total)',
                    rightTitle: 'Data e Hora ‚Üì',
                    rightSubtitle: 'Valor Usado | Vendas | ROI (Instagram Faixa 30min)'
                },
                'grupos': {
                    leftTitle: 'Data e Hora ‚Üì',
                    leftSubtitle: 'Valor Usado | Vendas | ROI (Grupos Total)',
                    rightTitle: 'Data e Hora ‚Üì',
                    rightSubtitle: 'Valor Usado | Vendas | ROI (Grupos Faixa 30min)'
                }
            };

            const config = titles[view] || titles['geral'];
            
            const leftTitle = document.getElementById('leftColumnTitle');
            const leftSubtitle = document.getElementById('leftColumnSubtitle');
            const rightTitle = document.getElementById('rightColumnTitle');
            const rightSubtitle = document.getElementById('rightColumnSubtitle');
            
            if (leftTitle) leftTitle.textContent = config.leftTitle;
            if (leftSubtitle) leftSubtitle.textContent = config.leftSubtitle;
            if (rightTitle) rightTitle.textContent = config.rightTitle;
            if (rightSubtitle) rightSubtitle.textContent = config.rightSubtitle;
        }

        // Initialize when DOM is ready
        // Dashboard View Management Functions
        function showDashboardView() {
            const orcamentoDashboard = document.getElementById('orcamentoDashboard');
            const twoColumnView = document.getElementById('twoColumnView');
            const horaPixView = document.getElementById('horaPixView');

            if (orcamentoDashboard) orcamentoDashboard.style.display = 'block';
            if (twoColumnView) twoColumnView.style.display = 'none';
            if (horaPixView) horaPixView.style.display = 'none';

            // Restaurar logo Imp√©rio
            updateLogoForView('dashboard');

            console.log('Dashboard view shown');
        }

        function showTableView() {
            const orcamentoDashboard = document.getElementById('orcamentoDashboard');
            const twoColumnView = document.getElementById('twoColumnView');
            const horaPixView = document.getElementById('horaPixView');

            if (orcamentoDashboard) orcamentoDashboard.style.display = 'none';
            if (twoColumnView) twoColumnView.style.display = 'block';
            if (horaPixView) horaPixView.style.display = 'none';

            // Restaurar logo Imp√©rio
            updateLogoForView('table');

            console.log('Table view shown');
        }
        
        // Dashboard Data Loading Functions
        async function loadDashboardData() {
            console.log('Loading dashboard data from database...');
            
            try {
                // Carregar dados do endpoint principal
                const response = await fetch('/api/imperio/dashboard');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateDashboardMetrics(data);
                    updateCollectionHistory(data.historico_coletas || []);
                } else {
                    console.error('Dashboard API error:', data);
                    // Manter cards vazios em vez de mostrar dados falsos
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Manter cards vazios em vez de mostrar dados falsos
            }
        }

        function updateCollectionHistory(history) {
            const container = document.getElementById('collectionHistory');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">Nenhum hist√≥rico dispon√≠vel</div>';
                return;
            }
            
            const historyHTML = history.map(item => {
                const successClass = item.status === 'success' ? 'success' : 'warning';
                const roiClass = item.roi >= 2.0 ? 'success' : (item.roi >= 1.5 ? 'warning' : 'danger');
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: rgba(255,255,255,0.8); border-radius: 8px; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #2c3e50;">${item.timestamp}</div>
                            <div style="font-size: 0.85rem; color: #666;">
                                <span class="badge bg-${successClass} me-2">${item.status.toUpperCase()}</span>
                                ${item.status === 'success' ? 'Coleta realizada com sucesso' : 'Coleta com problemas'}
                            </div>
                        </div>
                        <div style="text-align: right; font-size: 0.9rem;">
                            <div><strong>ROI:</strong> <span class="text-${roiClass}">${item.roi.toFixed(2)}</span></div>
                            <div><strong>Vendas:</strong> R$ ${item.vendas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            <div><strong>Lucro:</strong> R$ ${item.lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = historyHTML;
        }
        
        function updateDashboardMetrics(data) {
            const totals = data.totals || {};
            const canais = data.channels || {};
            
            // Atualizar cards principais com dados dos totals
            document.getElementById('roiGeral').textContent = (totals.roi || 0).toFixed(2);
            document.getElementById('vendasHoje').textContent = `R$ ${(totals.sales || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('gastosHoje').textContent = `R$ ${(totals.spend || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('lucroHoje').textContent = `R$ ${(totals.profit || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            // Atualizar cards de canais
            if (canais.geral) {
                document.getElementById('roiGeral2').textContent = (canais.geral.roi || 0).toFixed(2);
                document.getElementById('vendasGeral').textContent = `R$ ${(canais.geral.sales || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('gastosGeral').textContent = `R$ ${(canais.geral.spend || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('lucroGeral').textContent = `R$ ${(canais.geral.profit || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('orcamentoGeral').textContent = `R$ ${(canais.geral.budget || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
            
            if (canais.instagram) {
                document.getElementById('roiInstagram').textContent = (canais.instagram.roi || 0).toFixed(2);
                document.getElementById('vendasInstagram').textContent = `R$ ${(canais.instagram.sales || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('gastosInstagram').textContent = `R$ ${(canais.instagram.spend || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('lucroInstagram').textContent = `R$ ${(canais.instagram.profit || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('orcamentoInstagram').textContent = `R$ ${(canais.instagram.budget || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
            
            if (canais.grupos) {
                document.getElementById('roiGrupos').textContent = (canais.grupos.roi || 0).toFixed(2);
                document.getElementById('vendasGrupos').textContent = `R$ ${(canais.grupos.sales || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('gastosGrupos').textContent = `R$ ${(canais.grupos.spend || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('lucroGrupos').textContent = `R$ ${(canais.grupos.profit || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('orcamentoGrupos').textContent = `R$ ${(canais.grupos.budget || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
            
            // Atualizar status
            document.getElementById('lastCollectionInfo').textContent = `√öltima coleta: ${data.last_update || '--'}`;
        }
        
        // Fun√ß√£o removida para evitar interfer√™ncia com dados reais
        
        function updateCollectionStatus(data) {
            const lastUpdate = document.getElementById('lastUpdate');
            const dataCount = document.getElementById('dataCount');
            
            if (lastUpdate && data.last_update) {
                const updateDate = new Date(data.last_update);
                lastUpdate.textContent = `√öltima coleta: ${updateDate.toLocaleString('pt-BR')}`;
            }
            
            if (dataCount) {
                dataCount.textContent = `Per√≠odo: ${data.calculation_period || 'Dados cumulativos de hoje'}`;
            }
        }
        
        async function updateROIChart() {
            const canvas = document.getElementById('roiChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if exists
            if (window.roiChartInstance) {
                window.roiChartInstance.destroy();
            }
            
            // Sample data for ROI evolution
            const labels = [];
            const roiData = [];
            
            // Generate last 12 hours data
            for (let i = 11; i >= 0; i--) {
                const hour = new Date();
                hour.setHours(hour.getHours() - i);
                labels.push(hour.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}));
                
                // Simulate ROI evolution (starting lower, improving over time)
                const baseROI = 1.8 + (Math.random() * 0.6);
                const trend = (11 - i) * 0.03; // Positive trend
                roiData.push(Math.max(0, baseROI + trend + (Math.random() * 0.2 - 0.1)));
            }
            
            window.roiChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ROI',
                        data: roiData,
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 3,
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return value.toFixed(1) + 'x';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // =============================================
        
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Imperio dashboard...');
            
            // Set today's date FIRST
            const dateInput = document.getElementById('dateFilter');
            const today = new Date().toISOString().split('T')[0];
            if (dateInput) {
                dateInput.value = today;
                console.log('Date input set to:', today);
            } else {
                console.error('Date input element not found!');
            }
            
            // Setup navigation
            setupNavigation();
            
            // Load initial view based on hash (default to orcamento)
            const hash = window.location.hash.substring(1) || 'orcamento';
            currentView = hash;
            updateActiveMenuItem(hash);
            
            console.log('Initializing with view:', hash);
            
            // Small delay to ensure DOM is fully ready
            setTimeout(() => {
                if (hash === 'orcamento') {
                    showDashboardView();
                    loadDashboardData();
                } else if (hash === 'horapix') {
                    showHoraPixView(); // J√° carrega dados automaticamente
                } else if (hash === 'acaoprincipal') {
                    showMainActionView(); // J√° carrega dados automaticamente
                } else {
                    showTableView();
                    updateColumnTitles(hash);
                    // Carregamento √∫nico otimizado - sem chamadas duplas
                    loadAPIData(hash, false);
                }
            }, 250);
        });
        
        // REMOVIDO: Listener duplicado que causava chamadas duplas nas APIs
        
        // === AGENDAMENTO AUTOM√ÅTICO DE COLETA ===
        let collectionInterval = null;
        
        function startAutoCollection() {
            console.log('Iniciando coleta autom√°tica a cada 30 minutos...');
            
            // Limpar intervalo existente se houver
            if (collectionInterval) {
                clearInterval(collectionInterval);
            }
            
            // DESABILITADO: Coleta autom√°tica JavaScript (servidor cuida disso)
            // collectionInterval = setInterval(() => {
            //     console.log('Executando coleta autom√°tica...');
            //     executeCollectionNow(true); // true = autom√°tica
            // }, 1800000); // 30 minutos
            console.log('‚ö†Ô∏è Coleta autom√°tica JavaScript DESABILITADA - servidor cuida das coletas');
            
            console.log('Agendamento de coleta configurado com sucesso!');
        }
        
        function stopAutoCollection() {
            if (collectionInterval) {
                clearInterval(collectionInterval);
                collectionInterval = null;
                console.log('Agendamento de coleta interrompido.');
            }
        }
        
        // === FUN√á√ÉO COLETAR AGORA ===
        async function executeCollectionNow(isAutomatic = false) {
            console.log('üîÑ INICIANDO COLETA:', isAutomatic ? 'AUTOM√ÅTICA' : 'MANUAL');
            
            const btn = document.getElementById('coletarAgoraBtn');
            if (!btn) {
                console.error('Bot√£o coletarAgoraBtn n√£o encontrado!');
                return;
            }
            
            const originalText = btn.innerHTML;
            
            try {
                // Mostrar loading
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Coletando...';
                btn.disabled = true;
                
                console.log('üì° Fazendo requisi√ß√£o para /api/imperio/collect-now...');
                
                // Chamar API de coleta
                const response = await fetch('/api/imperio/collect-now', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Resposta recebida, status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üì¶ Dados da coleta:', result);
                
                if (result.status === 'success') {
                    console.log('‚úÖ COLETA REALIZADA COM SUCESSO!');
                    if (!isAutomatic) {
                        alert('‚úÖ Coleta realizada com sucesso! Nova linha adicionada √†s tabelas.');
                    }
                    
                    // Atualizar dashboard ap√≥s coleta
                    console.log('üîÑ Atualizando dashboard...');
                    await refreshDashboard();
                    console.log('‚úÖ Dashboard atualizado!');
                } else {
                    console.error('‚ùå ERRO NA COLETA:', result);
                    if (!isAutomatic) {
                        alert('‚ùå Erro na coleta: ' + (result.message || 'Erro desconhecido'));
                    }
                }
                
            } catch (error) {
                console.error('üí• ERRO DE CONEX√ÉO:', error);
                if (!isAutomatic) {
                    alert('‚ùå Erro de conex√£o: ' + error.message);
                }
            } finally {
                // Restaurar bot√£o
                btn.innerHTML = originalText;
                btn.disabled = false;
                console.log('üîÑ Bot√£o restaurado');
            }
        }
        
        // === FUN√á√ÉO REFRESH DASHBOARD ===
        async function refreshDashboard() {
            console.log('üîÑ Atualizando dashboard/tabelas...');
            
            try {
                if (currentView === 'orcamento') {
                    console.log('üìä Atualizando dashboard de or√ßamento...');
                    await loadDashboardData();
                } else {
                    console.log('üìä Atualizando tabelas Looker:', currentView);
                    await loadAPIData(currentView, false);
                }
                console.log('‚úÖ Atualiza√ß√£o conclu√≠da!');
            } catch (error) {
                console.error('‚ùå Erro ao atualizar:', error);
                alert('Erro ao atualizar dados: ' + error.message);
            }
        }
        
        // === GERENCIAMENTO DE PRODUTO ===
        let currentProductId = '68ff78f80d0e097d617d472b';

        function validateProductId(productId) {
            // Validar formato b√°sico do ID (24 caracteres hexadecimais)
            const hexPattern = /^[a-fA-F0-9]{24}$/;
            return hexPattern.test(productId);
        }

        async function changeProduct() {
            const input = document.getElementById('productIdInput');
            const newProductId = input.value.trim();
            
            // Valida√ß√£o b√°sica
            if (!newProductId) {
                alert('‚ùå Digite um ID de produto v√°lido.');
                input.focus();
                return;
            }
            
            if (!validateProductId(newProductId)) {
                alert('‚ùå ID de produto inv√°lido. Deve ter 24 caracteres hexadecimais.');
                input.focus();
                return;
            }
            
            if (newProductId === currentProductId) {
                alert('‚ÑπÔ∏è Este produto j√° est√° sendo monitorado.');
                return;
            }
            
            const confirmed = confirm(`üîÑ Alterar para o produto ${newProductId}?\\n\\nIsso reiniciar√° o monitoramento com dados do novo produto.`);
            if (!confirmed) {
                input.value = currentProductId; // Reverter
                return;
            }
            
            // Desabilitar campo durante processamento
            input.disabled = true;
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            saveBtn.disabled = true;
            
            try {
                const response = await fetch('/api/imperio/change-product', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({product_id: newProductId})
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentProductId = newProductId;
                    alert('‚úÖ Produto alterado com sucesso! Monitoramento reiniciado.');
                    console.log('Novo produto:', newProductId);
                    await refreshDashboard();
                } else {
                    alert('‚ùå Erro ao alterar produto: ' + (result.message || result.error));
                    input.value = currentProductId; // Reverter
                }
            } catch (error) {
                console.error('Erro ao alterar produto:', error);
                alert('‚ùå Erro de conex√£o: ' + error.message);
                input.value = currentProductId; // Reverter
            } finally {
                // Reabilitar campo
                input.disabled = false;
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // Fun√ß√£o resetToDefault removida

        // Permitir salvar com Enter
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('productIdInput');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changeProduct();
                    }
                });
                
                // Highlight no foco
                input.addEventListener('focus', function() {
                    this.select();
                });
            }
        });

        // HORA DO PIX - JAVASCRIPT (DARK THEME UNIFIED)
        // ============================================

        let currentHoraPixTab = 'monitoramento';
        let horaPixDrawsData = [];

        // Trocar tabs (APENAS 2 TABS)
        function switchHoraPixTab(tab) {
            currentHoraPixTab = tab;

            // Atualizar bot√µes
            document.getElementById('tabHoraPixMonitoramento').classList.remove('active');
            document.getElementById('tabHoraPixEstatisticas').classList.remove('active');

            // Esconder conte√∫dos
            document.getElementById('horaPixMonitoramentoContent').style.display = 'none';
            document.getElementById('horaPixEstatisticasContent').style.display = 'none';

            // Mostrar tab selecionada
            if (tab === 'monitoramento') {
                document.getElementById('tabHoraPixMonitoramento').classList.add('active');
                document.getElementById('horaPixMonitoramentoContent').style.display = 'block';
            } else if (tab === 'estatisticas') {
                document.getElementById('tabHoraPixEstatisticas').classList.add('active');
                document.getElementById('horaPixEstatisticasContent').style.display = 'block';
                renderHoraPixChart();
            }
        }

        // Carregar dados do Hora do Pix
        async function loadHoraPixData() {
            console.log('Loading Hora do Pix data...');

            try {
                const response = await fetch('/api/imperio/horapix/latest');
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    horaPixDrawsData = result.data.draws || [];
                    updateHoraPixUI(result.data);
                } else {
                    console.warn('Nenhum dado Hora do Pix dispon√≠vel');
                    showEmptyHoraPixState();
                }
            } catch (error) {
                console.error('Erro ao carregar Hora do Pix:', error);
                showHoraPixError();
            }
        }

        // Atualizar UI com dados
        function updateHoraPixUI(data) {
            const totals = data.totals || {};
            const draws = data.draws || [];

            // Separar ativos e finalizados
            const ativos = draws.filter(d => d.status === 'active');
            const finalizados = draws.filter(d => d.status === 'done');

            // Calcular totais separados
            const totaisFinalizados = {
                count: finalizados.length,
                receita: finalizados.reduce((sum, d) => sum + (d.revenue || 0), 0),
                premio: finalizados.reduce((sum, d) => sum + (d.prize_value || 0), 0),
                taxa: finalizados.reduce((sum, d) => sum + (d.platform_fee || 0), 0),
                lucro: finalizados.reduce((sum, d) => sum + (d.profit || 0), 0)
            };
            totaisFinalizados.custos = totaisFinalizados.premio + totaisFinalizados.taxa;
            totaisFinalizados.margem = totaisFinalizados.custos > 0 ?
                (totaisFinalizados.lucro / totaisFinalizados.custos * 100) : 0;

            const totaisAtivos = {
                count: ativos.length,
                receita: ativos.reduce((sum, d) => sum + (d.revenue || 0), 0),
                premio: ativos.reduce((sum, d) => sum + (d.prize_value || 0), 0),
                taxa: ativos.reduce((sum, d) => sum + (d.platform_fee || 0), 0),
                lucro: ativos.reduce((sum, d) => sum + (d.profit || 0), 0)
            };
            totaisAtivos.custos = totaisAtivos.premio + totaisAtivos.taxa;

            // Atualizar KPIs Finalizados (azul)
            document.getElementById('kpiFinalizadosCount').textContent = totaisFinalizados.count;
            document.getElementById('kpiFinalizadosReceita').textContent =
                'R$ ' + totaisFinalizados.receita.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('kpiFinalizadosCustos').textContent =
                'R$ ' + totaisFinalizados.custos.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('kpiFinalizadosLucro').textContent =
                'R$ ' + totaisFinalizados.lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('kpiFinalizadosMargin').textContent =
                'Margem: ' + totaisFinalizados.margem.toFixed(1) + '%';

            // Atualizar KPIs Ativos (verde)
            document.getElementById('kpiAtivosCount').textContent = totaisAtivos.count;
            document.getElementById('kpiAtivosReceita').textContent =
                'R$ ' + totaisAtivos.receita.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('kpiAtivosCustos').textContent =
                'R$ ' + totaisAtivos.custos.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('kpiAtivosLucro').textContent =
                'R$ ' + totaisAtivos.lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2});

            // Atualizar badges
            document.getElementById('badgeHoraPixActive').textContent = totaisAtivos.count;
            document.getElementById('badgeHoraPixFinished').textContent = totaisFinalizados.count;
            document.getElementById('badgeHoraPixTotal').textContent = draws.length;

            // Ajustar espa√ßamento proporcional entre tabelas
            adjustTableSpacing(ativos.length, finalizados.length);

            // Renderizar tabelas
            renderHoraPixTable('horaPixAtivasList', ativos);
            renderHoraPixTable('horaPixFinalizadasList', finalizados, true);
        }

        // Ajustar espa√ßamento proporcional entre tabelas
        function adjustTableSpacing(ativosCount, finalizadosCount) {
            const spacer = document.getElementById('horaPixSpacer');
            if (!spacer) return;

            // Propor√ß√£o: mais sorteios = mais espa√ßo (max 80px, min 20px)
            const totalSorteios = ativosCount + finalizadosCount;
            const baseSpacing = 20;
            const additionalSpacing = Math.min(60, totalSorteios * 2);
            const finalSpacing = baseSpacing + additionalSpacing;

            spacer.style.height = finalSpacing + 'px';
        }

        // Renderizar tabela de sorteios
        function renderHoraPixTable(elementId, draws, isFinished = false) {
            const tbody = document.getElementById(elementId);

            if (!draws || draws.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nenhum sorteio ' + (isFinished ? 'finalizado' : 'ativo') + '</td></tr>';
                return;
            }

            let html = '';
            draws.forEach(draw => {
                const percentSold = draw.qty_total > 0 ? (draw.qty_paid / draw.qty_total * 100).toFixed(1) : 0;
                const statusBadge = isFinished ?
                    '<span class="badge bg-success" style="font-size: 10px;">Finalizado</span>' :
                    '<span class="badge bg-primary" style="font-size: 10px;">Ativo</span>';

                const roiColor = draw.roi > 0 ? '#00ff00' : '#ff6b6b';
                const lucroColor = draw.profit > 0 ? '#00ff00' : '#ff6b6b';

                html += '<tr style="cursor: pointer;" onclick="showDrawDetails(\'' + draw.id + '\')">';
                html += '<td style="color: #fff;">' + draw.title + '</td>';
                html += '<td style="text-align: center;">' + statusBadge + '</td>';
                html += '<td style="text-align: right; color: #ffc107;">' + (draw.prize_value || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>';
                html += '<td style="text-align: right; color: #ffc107;">' + (draw.revenue || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>';
                html += '<td style="text-align: right; color: #ff6b6b;">-' + (draw.platform_fee || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>';
                html += '<td style="text-align: right; color: ' + lucroColor + ';">' + (draw.profit || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>';
                html += '<td style="text-align: right; color: ' + roiColor + ';">' + (draw.roi || 0).toFixed(2) + '%</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        // Mostrar detalhes do sorteio (insights)
        async function showDrawDetails(drawId) {
            console.log('Fetching details for draw:', drawId);

            // TODO: Implementar chamada ao endpoint /horapix/{id}/insights
            // Por enquanto, apenas trocar para a aba de estat√≠sticas
            switchHoraPixTab('estatisticas');
        }

        // Renderizar gr√°fico Chart.js (COM HEIGHT FIXO PARA EVITAR EXPANS√ÉO)
        let horaPixChartInstance = null;
        function renderHoraPixChart() {
            const canvas = document.getElementById('horaPixChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destruir gr√°fico anterior se existir
            if (horaPixChartInstance) {
                horaPixChartInstance.destroy();
            }

            // Preparar dados
            const labels = horaPixDrawsData.map(d => d.title.substring(0, 30) + '...');
            const receitas = horaPixDrawsData.map(d => d.revenue || 0);
            const lucros = horaPixDrawsData.map(d => d.profit || 0);
            const taxas = horaPixDrawsData.map(d => d.platform_fee || 0);

            horaPixChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Receita',
                            data: receitas,
                            backgroundColor: '#00D9FF',
                            borderColor: '#00D9FF',
                            borderWidth: 1
                        },
                        {
                            label: 'Lucro',
                            data: lucros,
                            backgroundColor: '#00ff00',
                            borderColor: '#00ff00',
                            borderWidth: 1
                        },
                        {
                            label: 'Taxa 3%',
                            data: taxas,
                            backgroundColor: '#ff6b6b',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff', maxRotation: 45, minRotation: 45 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // Estados vazios/erro
        function showEmptyHoraPixState() {
            document.getElementById('horaPixAtivasList').innerHTML =
                '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nenhum dado dispon√≠vel. Clique em "Atualizar Agora"</td></tr>';
            document.getElementById('horaPixFinalizadasList').innerHTML =
                '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nenhum dado dispon√≠vel.</td></tr>';
        }

        function showHoraPixError() {
            document.getElementById('horaPixAtivasList').innerHTML =
                '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ff6b6b;">Erro ao carregar dados. Tente novamente.</td></tr>';
        }

        // Coletar dados agora
        async function collectHoraPixNow() {
            try {
                const response = await fetch('/api/imperio/horapix/collect', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    console.log('Coleta realizada com sucesso');
                    await loadHoraPixData();
                } else {
                    console.error('Erro na coleta:', result.error);
                    alert('Erro ao coletar dados: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao coletar dados:', error);
                alert('Erro ao coletar dados. Verifique o console.');
            }
        }

        // Trocar logo dinamicamente (Imp√©rio <-> Hora do Pix)
        function updateLogoForView(view) {
            const logoImg = document.getElementById('imperio-logo');
            if (!logoImg) return;

            if (view === 'horapix') {
                // Trocar para logo Hora do Pix - escala aumentada
                logoImg.src = '/static/hora_do_pix.png';
                logoImg.alt = 'Hora do Pix Logo';
                logoImg.style.maxWidth = '120px'; // mesmo espa√ßo
                logoImg.style.transform = 'scale(1.8)'; // escala 80% maior
            } else {
                // Voltar para logo Imp√©rio - tamanho padr√£o
                logoImg.src = '/static/logo.png';
                logoImg.alt = 'Imp√©rio Logo';
                logoImg.style.maxWidth = '120px'; // tamanho padr√£o
                logoImg.style.transform = 'scale(1)'; // escala normal
            }
        }

        // Mostrar view Hora do Pix
        function showHoraPixView() {
            const orcamentoDashboard = document.getElementById('orcamentoDashboard');
            const twoColumnView = document.getElementById('twoColumnView');
            const horaPixView = document.getElementById('horaPixView');

            if (orcamentoDashboard) orcamentoDashboard.style.display = 'none';
            if (twoColumnView) twoColumnView.style.display = 'none';
            if (horaPixView) horaPixView.style.display = 'block';

            // Trocar logo para Hora do Pix
            updateLogoForView('horapix');

            // Carregar dados automaticamente quando view √© exibida
            loadHoraPixData();

            console.log('Hora do Pix view shown');
        }

        // === INICIALIZA√á√ÉO LIMPA - SEM COLETAS AUTOM√ÅTICAS ===
        console.log('‚úÖ Sistema carregado - APENAS scheduler backend (30min) faz coletas autom√°ticas');

        // Parar agendamento quando p√°gina for fechada
        window.addEventListener('beforeunload', function() {
            stopAutoCollection();
        });

        console.log('Inline JavaScript loaded successfully!');

        // ============================================
        // A√á√ÉO PRINCIPAL - JAVASCRIPT
        // ============================================
        {% include '_main_action_javascript.js' %}

    </script>
</body>
</html>