<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Ads - ROI Império</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background-color: #2c3e50;
            min-height: 100vh;
            padding: 0;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 15px 20px;
            border-radius: 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            background-color: #34495e;
            color: #fff;
        }
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: #fff;
        }
        .facebook-card {
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 15px;
        }
        .account-badge {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="text-center py-4">
                    <h5 class="text-white">
                        <i class="fas fa-chart-line"></i> ROI Império
                    </h5>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-dashboard me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/config">
                            <i class="fas fa-cog me-2"></i>Configurações
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/campaigns">
                            <i class="fas fa-bullhorn me-2"></i>Campanhas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/affiliates">
                            <i class="fas fa-users me-2"></i>Afiliados
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/facebook">
                            <i class="fab fa-facebook me-2"></i>Facebook Ads
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">
                            <i class="fas fa-history me-2"></i>Histórico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">
                            <i class="fas fa-chart-bar me-2"></i>Análises
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 py-4" style="background-color: #f8f9fa;">
                <!-- Header -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1 class="h2 mb-1">
                                    <i class="fab fa-facebook text-primary me-2"></i>
                                    Dashboard Facebook Ads
                                </h1>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-chart-bar me-1"></i>
                                    Monitoramento dos gastos e performance das campanhas
                                </p>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-primary" onclick="refreshFacebookData()">
                                    <i class="fas fa-refresh me-1"></i>Atualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status das Contas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info" role="alert">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fab fa-facebook me-2"></i>
                                    <strong>Contas Ativas:</strong> <span id="active-accounts">4</span> contas
                                    <span class="ms-3">
                                        <i class="fas fa-clock me-1"></i>
                                        Última sincronização: <span id="last-sync">--</span>
                                    </span>
                                </div>
                                <div>
                                    <span class="badge bg-success">Sistema Ativo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Métricas do Facebook -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card facebook-card text-center text-white" style="background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);">
                            <div class="card-body">
                                <h5 class="card-title">Gasto Hoje</h5>
                                <h2 class="mb-0" id="today-spend">R$ 0</h2>
                                <small>Orçamento: R$ 10.000</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card facebook-card text-center text-white" style="background: linear-gradient(135deg, #42a5f5 0%, #66bb6a 100%);">
                            <div class="card-body">
                                <h5 class="card-title">Impressões</h5>
                                <h2 class="mb-0" id="total-impressions">0</h2>
                                <small>Alcance total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card facebook-card text-center text-white" style="background: linear-gradient(135deg, #ff7043 0%, #ffab40 100%);">
                            <div class="card-body">
                                <h5 class="card-title">Cliques</h5>
                                <h2 class="mb-0" id="total-clicks">0</h2>
                                <small>CTR: <span id="ctr">0%</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card facebook-card text-center text-white" style="background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%);">
                            <div class="card-body">
                                <h5 class="card-title">CPM</h5>
                                <h2 class="mb-0" id="average-cpm">R$ 0</h2>
                                <small>Custo por mil</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contas por Canal -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-layer-group me-2"></i>Contas por Canal
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6 class="text-primary">
                                            <i class="fas fa-globe me-1"></i>Canal Geral
                                        </h6>
                                        <div id="geral-accounts" class="mb-3">
                                            <small class="text-muted">Carregando...</small>
                                        </div>
                                        <div class="small">
                                            <strong>Gasto:</strong> <span id="geral-spend">R$ 0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-danger">
                                            <i class="fab fa-instagram me-1"></i>Instagram
                                        </h6>
                                        <div id="instagram-accounts" class="mb-3">
                                            <small class="text-muted">Carregando...</small>
                                        </div>
                                        <div class="small">
                                            <strong>Gasto:</strong> <span id="instagram-spend">R$ 0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-success">
                                            <i class="fab fa-whatsapp me-1"></i>Grupos WhatsApp
                                        </h6>
                                        <div id="grupos-accounts" class="mb-3">
                                            <small class="text-muted">Carregando...</small>
                                        </div>
                                        <div class="small">
                                            <strong>Gasto:</strong> <span id="grupos-spend">R$ 0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Histórico de Gastos -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Histórico de Gastos (Últimas 24h)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Data/Hora</th>
                                                <th>Conta</th>
                                                <th>Canal</th>
                                                <th>Gasto</th>
                                                <th>Impressões</th>
                                                <th>Cliques</th>
                                                <th>CPM</th>
                                                <th>CPC</th>
                                            </tr>
                                        </thead>
                                        <tbody id="facebook-table">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Carregando dados...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mock data baseado nos dados reais do sistema
        const mockFacebookData = [
            {
                timestamp: new Date().toISOString(),
                accounts: [
                    {
                        account_id: "act_2067257390316380",
                        spend: 1250.50,
                        impressions: 45000,
                        clicks: 890,
                        channel: "geral"
                    },
                    {
                        account_id: "act_1391112848236399", 
                        spend: 980.25,
                        impressions: 38000,
                        clicks: 720,
                        channel: "instagram"
                    },
                    {
                        account_id: "act_406219475582745",
                        spend: 1420.75,
                        impressions: 52000,
                        clicks: 1050,
                        channel: "grupos"
                    },
                    {
                        account_id: "act_790223756353632",
                        spend: 890.30,
                        impressions: 29000,
                        clicks: 580,
                        channel: "geral"
                    }
                ]
            }
        ];

        async function loadFacebookData() {
            try {
                const response = await fetch('/api/facebook/spend');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateFacebookTable(data.data);
                    updateFacebookMetrics(data.data);
                } else {
                    // Fallback para dados mock
                    updateFacebookTable(mockFacebookData);
                    updateFacebookMetrics(mockFacebookData);
                }
                
                await updateAccountsByChannel();
                
            } catch (error) {
                console.error('Erro ao carregar dados do Facebook:', error);
                document.getElementById('facebook-table').innerHTML = 
                    '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>';
            }
        }

        function updateFacebookTable(data) {
            const tableBody = document.getElementById('facebook-table');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum dado disponível</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                item.accounts.forEach(account => {
                    const row = document.createElement('tr');
                    const cpm = account.impressions > 0 ? ((account.spend / account.impressions) * 1000) : 0;
                    const cpc = account.clicks > 0 ? (account.spend / account.clicks) : 0;
                    
                    // Ícone e cor do canal
                    let channelIcon = 'fas fa-globe';
                    let channelColor = 'primary';
                    if (account.channel === 'instagram') {
                        channelIcon = 'fab fa-instagram';
                        channelColor = 'danger';
                    } else if (account.channel === 'grupos') {
                        channelIcon = 'fab fa-whatsapp';
                        channelColor = 'success';
                    }
                    
                    row.innerHTML = `
                        <td>${new Date(item.timestamp).toLocaleString('pt-BR')}</td>
                        <td><code class="account-badge">${account.account_id}</code></td>
                        <td>
                            <span class="badge bg-${channelColor}">
                                <i class="${channelIcon} me-1"></i>${account.channel}
                            </span>
                        </td>
                        <td><strong>R$ ${account.spend.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td>${(account.impressions || 0).toLocaleString('pt-BR')}</td>
                        <td>${(account.clicks || 0).toLocaleString('pt-BR')}</td>
                        <td>R$ ${cpm.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td>R$ ${cpc.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            });
        }

        function updateFacebookMetrics(data) {
            let totalSpend = 0;
            let totalImpressions = 0;
            let totalClicks = 0;
            let uniqueAccounts = new Set();
            
            data.forEach(item => {
                item.accounts.forEach(account => {
                    totalSpend += account.spend || 0;
                    totalImpressions += account.impressions || 0;
                    totalClicks += account.clicks || 0;
                    uniqueAccounts.add(account.account_id);
                });
            });
            
            const ctr = totalImpressions > 0 ? ((totalClicks / totalImpressions) * 100) : 0;
            const cpm = totalImpressions > 0 ? ((totalSpend / totalImpressions) * 1000) : 0;
            
            document.getElementById('today-spend').textContent = 
                'R$ ' + totalSpend.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('total-impressions').textContent = totalImpressions.toLocaleString('pt-BR');
            document.getElementById('total-clicks').textContent = totalClicks.toLocaleString('pt-BR');
            document.getElementById('ctr').textContent = ctr.toFixed(2) + '%';
            document.getElementById('average-cpm').textContent = 
                'R$ ' + cpm.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('active-accounts').textContent = uniqueAccounts.size;
        }

        async function updateAccountsByChannel() {
            try {
                // Buscar configuração atual de canais
                const response = await fetch('/api/config');
                const configData = await response.json();
                
                const channelMapping = configData.config?.channel_mapping || {
                    geral: ["act_2067257390316380", "act_1391112848236399", "act_406219475582745", "act_790223756353632"],
                    instagram: [],
                    grupos: []
                };
                
                // Calcular gastos por canal baseado no mapeamento
                const spendByChannel = { geral: 0, instagram: 0, grupos: 0 };
                
                mockFacebookData[0].accounts.forEach(account => {
                    for (const [channel, accounts] of Object.entries(channelMapping)) {
                        if (accounts.includes(account.account_id)) {
                            spendByChannel[channel] += account.spend;
                            break;
                        }
                    }
                });
                
                // Atualizar display dos canais
                Object.keys(channelMapping).forEach(channel => {
                    const container = document.getElementById(`${channel}-accounts`);
                    const spendElement = document.getElementById(`${channel}-spend`);
                    
                    if (container && spendElement) {
                        container.innerHTML = '';
                        
                        if (channelMapping[channel].length === 0) {
                            container.innerHTML = '<small class="text-muted">Nenhuma conta configurada</small>';
                        } else {
                            channelMapping[channel].forEach(accountId => {
                                const badge = document.createElement('span');
                                badge.className = 'badge bg-secondary me-1 mb-1 account-badge';
                                badge.textContent = accountId;
                                container.appendChild(badge);
                            });
                        }
                        
                        spendElement.textContent = 'R$ ' + spendByChannel[channel].toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar configuração de canais:', error);
                
                // Fallback para configuração padrão
                const defaultChannels = {
                    geral: ["act_2067257390316380", "act_1391112848236399", "act_406219475582745", "act_790223756353632"],
                    instagram: [],
                    grupos: []
                };
                
                Object.keys(defaultChannels).forEach(channel => {
                    const container = document.getElementById(`${channel}-accounts`);
                    if (container) {
                        container.innerHTML = '';
                        defaultChannels[channel].forEach(accountId => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1 mb-1 account-badge';
                            badge.textContent = accountId;
                            container.appendChild(badge);
                        });
                    }
                });
            }
        }

        function refreshFacebookData() {
            document.getElementById('last-sync').textContent = 'Atualizando...';
            document.getElementById('facebook-table').innerHTML = 
                '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Atualizando...</td></tr>';
            
            setTimeout(() => {
                loadFacebookData().then(() => {
                    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString('pt-BR');
                });
            }, 1000);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadFacebookData();
            
            // Atualizar a cada 2 minutos
            setInterval(loadFacebookData, 120000);
            
            // Atualizar timestamp da última sincronização
            document.getElementById('last-sync').textContent = new Date().toLocaleTimeString('pt-BR');
        });
    </script>
</body>
</html>