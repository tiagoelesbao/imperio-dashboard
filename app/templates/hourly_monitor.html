<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Horário - ROI Império</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            background-color: #2c3e50;
            min-height: 100vh;
            padding: 0;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 15px 20px;
            border-radius: 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            background-color: #34495e;
            color: #fff;
        }
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: #fff;
        }
        .chart-container {
            height: 400px;
            position: relative;
        }
        .metric-card {
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 15px;
            transition: transform 0.3s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .status-excellent { background-color: #d4edda; color: #155724; }
        .status-good { background-color: #fff3cd; color: #856404; }
        .status-warning { background-color: #f8d7da; color: #721c24; }
        .cumulative-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="text-center py-4">
                    <h5 class="text-white">
                        <i class="fas fa-chart-line"></i> ROI Império
                    </h5>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-dashboard me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/config">
                            <i class="fas fa-cog me-2"></i>Configurações
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/campaigns">
                            <i class="fas fa-bullhorn me-2"></i>Campanhas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/affiliates">
                            <i class="fas fa-users me-2"></i>Afiliados
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/facebook">
                            <i class="fab fa-facebook me-2"></i>Facebook Ads
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/hourly-monitor">
                            <i class="fas fa-clock me-2"></i>Monitor Horário
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">
                            <i class="fas fa-history me-2"></i>Histórico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">
                            <i class="fas fa-chart-bar me-2"></i>Análises
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 py-4" style="background-color: #f8f9fa;">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h2 mb-1">
                                    <i class="fas fa-clock text-primary me-2"></i>
                                    Monitoramento Horário - ROI em Tempo Real
                                </h1>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-chart-line me-1"></i>
                                    Análise detalhada como no Looker Studio com dados por intervalo e acumulados do dia
                                </p>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-primary me-2" onclick="refreshData()">
                                    <i class="fas fa-sync-alt me-1"></i>Atualizar
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportData()">
                                    <i class="fas fa-download me-1"></i>Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status da Campanha Ativa -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-primary" role="alert">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-bullhorn me-2"></i>
                                    <strong>Campanha Ativa:</strong> <span id="campaign-name">Sorteio 200mil</span>
                                    <span class="ms-3">
                                        <i class="fas fa-calendar me-1"></i>
                                        Hoje: <span id="campaign-date">--</span>
                                    </span>
                                    <span class="ms-3">
                                        <i class="fas fa-eye me-1"></i>
                                        Última coleta: <span id="last-update">--</span>
                                    </span>
                                </div>
                                <div>
                                    <select class="form-select form-select-sm me-2" id="channel-filter" onchange="loadHourlyData()">
                                        <option value="all">Todos os Canais</option>
                                        <option value="geral">Canal Geral</option>
                                        <option value="instagram">Instagram</option>
                                        <option value="grupos">Grupos WhatsApp</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Métricas do Dia -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card metric-card text-center text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="card-body">
                                <h5 class="card-title">ROI do Dia</h5>
                                <h2 class="mb-0" id="day-roi">0.00</h2>
                                <small>Meta: <span id="roi-goal">2.00</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card text-center text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            <div class="card-body">
                                <h5 class="card-title">Vendas Acumuladas</h5>
                                <h2 class="mb-0" id="day-sales">R$ 0</h2>
                                <small>Última hora: <span id="last-hour-sales">R$ 0</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card text-center text-white" style="background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);">
                            <div class="card-body">
                                <h5 class="card-title">Gasto Acumulado</h5>
                                <h2 class="mb-0" id="day-spend">R$ 0</h2>
                                <small>Orçamento: <span id="daily-budget">R$ 10.000</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card text-center text-white" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            <div class="card-body">
                                <h5 class="card-title">Lucro do Dia</h5>
                                <h2 class="mb-0" id="day-profit">R$ 0</h2>
                                <small>Margem: <span id="day-margin">0%</span></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Evolução -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Evolução ROI Acumulativo - Últimas 24h
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="hourlyEvolutionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Monitoramento Horário -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-table me-2"></i>Histórico Cumulativo - Últimas 24h
                                    </h5>
                                    <div>
                                        <small class="text-muted">Atualização automática a cada 30s</small>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                    <table class="table table-hover table-striped">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th>Data e Hora</th>
                                                <th>Valor Usado (Intervalo)</th>
                                                <th>Vendas (Intervalo)</th>
                                                <th>ROI (Intervalo)</th>
                                                <th>Gasto Acumulado (Dia)</th>
                                                <th>Vendas Acumuladas (Dia)</th>
                                                <th>ROI Acumulado</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="hourly-table">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Carregando dados...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let hourlyChart;
        let hourlyData = [];

        // Dados mock baseados no padrão do Looker Studio
        const mockHourlyData = [
            {
                timestamp: new Date(Date.now() - 23*60*60*1000).toISOString(),
                period: "00:00 - 01:00",
                interval_spend: 127.50,
                interval_sales: 425.30,
                interval_roi: 2.33,
                day_spend: 127.50,
                day_sales: 425.30,
                day_roi: 2.33
            },
            {
                timestamp: new Date(Date.now() - 22*60*60*1000).toISOString(),
                period: "01:00 - 02:00",
                interval_spend: 89.20,
                interval_sales: 267.40,
                interval_roi: 2.00,
                day_spend: 216.70,
                day_sales: 692.70,
                day_roi: 2.20
            },
            {
                timestamp: new Date(Date.now() - 21*60*60*1000).toISOString(),
                period: "02:00 - 03:00",
                interval_spend: 45.80,
                interval_sales: 156.20,
                interval_roi: 2.41,
                day_spend: 262.50,
                day_sales: 848.90,
                day_roi: 2.23
            },
            {
                timestamp: new Date(Date.now() - 20*60*60*1000).toISOString(),
                period: "03:00 - 04:00",
                interval_spend: 23.40,
                interval_sales: 89.60,
                interval_roi: 2.83,
                day_spend: 285.90,
                day_sales: 938.50,
                day_roi: 2.28
            },
            {
                timestamp: new Date(Date.now() - 19*60*60*1000).toISOString(),
                period: "04:00 - 05:00",
                interval_spend: 34.60,
                interval_sales: 112.30,
                interval_roi: 2.24,
                day_spend: 320.50,
                day_sales: 1050.80,
                day_roi: 2.28
            },
            {
                timestamp: new Date(Date.now() - 18*60*60*1000).toISOString(),
                period: "05:00 - 06:00",
                interval_spend: 78.90,
                interval_sales: 234.50,
                interval_roi: 1.97,
                day_spend: 399.40,
                day_sales: 1285.30,
                day_roi: 2.22
            },
            {
                timestamp: new Date(Date.now() - 17*60*60*1000).toISOString(),
                period: "06:00 - 07:00",
                interval_spend: 156.80,
                interval_sales: 487.20,
                interval_roi: 2.11,
                day_spend: 556.20,
                day_sales: 1772.50,
                day_roi: 2.19
            },
            {
                timestamp: new Date(Date.now() - 16*60*60*1000).toISOString(),
                period: "07:00 - 08:00",
                interval_spend: 234.70,
                interval_sales: 789.40,
                interval_roi: 2.36,
                day_spend: 790.90,
                day_sales: 2561.90,
                day_roi: 2.24
            },
            {
                timestamp: new Date(Date.now() - 15*60*60*1000).toISOString(),
                period: "08:00 - 09:00",
                interval_spend: 289.30,
                interval_sales: 967.80,
                interval_roi: 2.35,
                day_spend: 1080.20,
                day_sales: 3529.70,
                day_roi: 2.27
            },
            {
                timestamp: new Date(Date.now() - 14*60*60*1000).toISOString(),
                period: "09:00 - 10:00",
                interval_spend: 345.60,
                interval_sales: 1234.50,
                interval_roi: 2.57,
                day_spend: 1425.80,
                day_sales: 4764.20,
                day_roi: 2.34
            },
            {
                timestamp: new Date(Date.now() - 13*60*60*1000).toISOString(),
                period: "10:00 - 11:00",
                interval_spend: 423.90,
                interval_sales: 1567.30,
                interval_roi: 2.70,
                day_spend: 1849.70,
                day_sales: 6331.50,
                day_roi: 2.42
            },
            {
                timestamp: new Date(Date.now() - 12*60*60*1000).toISOString(),
                period: "11:00 - 12:00",
                interval_spend: 398.20,
                interval_sales: 1456.80,
                interval_roi: 2.66,
                day_spend: 2247.90,
                day_sales: 7788.30,
                day_roi: 2.46
            },
            {
                timestamp: new Date(Date.now() - 11*60*60*1000).toISOString(),
                period: "12:00 - 13:00",
                interval_spend: 456.70,
                interval_sales: 1689.90,
                interval_roi: 2.70,
                day_spend: 2704.60,
                day_sales: 9478.20,
                day_roi: 2.50
            },
            {
                timestamp: new Date(Date.now() - 10*60*60*1000).toISOString(),
                period: "13:00 - 14:00",
                interval_spend: 389.40,
                interval_sales: 1234.60,
                interval_roi: 2.17,
                day_spend: 3094.00,
                day_sales: 10712.80,
                day_roi: 2.46
            },
            {
                timestamp: new Date(Date.now() - 9*60*60*1000).toISOString(),
                period: "14:00 - 15:00",
                interval_spend: 367.80,
                interval_sales: 1345.70,
                interval_roi: 2.66,
                day_spend: 3461.80,
                day_sales: 12058.50,
                day_roi: 2.48
            },
            {
                timestamp: new Date(Date.now() - 8*60*60*1000).toISOString(),
                period: "15:00 - 16:00",
                interval_spend: 445.20,
                interval_sales: 1456.30,
                interval_roi: 2.27,
                day_spend: 3907.00,
                day_sales: 13514.80,
                day_roi: 2.46
            },
            {
                timestamp: new Date(Date.now() - 7*60*60*1000).toISOString(),
                period: "16:00 - 17:00",
                interval_spend: 298.60,
                interval_sales: 967.40,
                interval_roi: 2.24,
                day_spend: 4205.60,
                day_sales: 14482.20,
                day_roi: 2.44
            },
            {
                timestamp: new Date(Date.now() - 6*60*60*1000).toISOString(),
                period: "17:00 - 18:00",
                interval_spend: 334.50,
                interval_sales: 1123.80,
                interval_roi: 2.36,
                day_spend: 4540.10,
                day_sales: 15606.00,
                day_roi: 2.44
            },
            {
                timestamp: new Date(Date.now() - 5*60*60*1000).toISOString(),
                period: "18:00 - 19:00",
                interval_spend: 267.30,
                interval_sales: 789.60,
                interval_roi: 1.95,
                day_spend: 4807.40,
                day_sales: 16395.60,
                day_roi: 2.41
            },
            {
                timestamp: new Date(Date.now() - 4*60*60*1000).toISOString(),
                period: "19:00 - 20:00",
                interval_spend: 198.70,
                interval_sales: 654.20,
                interval_roi: 2.29,
                day_spend: 5006.10,
                day_sales: 17049.80,
                day_roi: 2.41
            },
            {
                timestamp: new Date(Date.now() - 3*60*60*1000).toISOString(),
                period: "20:00 - 21:00",
                interval_spend: 156.40,
                interval_sales: 445.30,
                interval_roi: 1.85,
                day_spend: 5162.50,
                day_sales: 17495.10,
                day_roi: 2.39
            },
            {
                timestamp: new Date(Date.now() - 2*60*60*1000).toISOString(),
                period: "21:00 - 22:00",
                interval_spend: 89.20,
                interval_sales: 234.50,
                interval_roi: 1.63,
                day_spend: 5251.70,
                day_sales: 17729.60,
                day_roi: 2.37
            },
            {
                timestamp: new Date(Date.now() - 1*60*60*1000).toISOString(),
                period: "22:00 - 23:00",
                interval_spend: 67.80,
                interval_sales: 189.40,
                interval_roi: 1.79,
                day_spend: 5319.50,
                day_sales: 17919.00,
                day_roi: 2.37
            },
            {
                timestamp: new Date().toISOString(),
                period: "23:00 - 00:00",
                interval_spend: 45.30,
                interval_sales: 123.60,
                interval_roi: 1.73,
                day_spend: 5364.80,
                day_sales: 18042.60,
                day_roi: 2.36
            }
        ];

        async function loadHourlyData() {
            try {
                // Simular carregamento da API
                // const response = await fetch('/api/hourly-roi?hours=24');
                // const data = await response.json();
                
                // Usar dados mock por enquanto
                hourlyData = mockHourlyData;
                
                updateHourlyTable(hourlyData);
                updateDayMetrics(hourlyData);
                updateHourlyChart(hourlyData);
                updateLastUpdate();
                
            } catch (error) {
                console.error('Erro ao carregar dados horários:', error);
                document.getElementById('hourly-table').innerHTML = 
                    '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>';
            }
        }

        function updateHourlyTable(data) {
            const tableBody = document.getElementById('hourly-table');
            tableBody.innerHTML = '';
            
            data.reverse().forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Status baseado no ROI do intervalo
                let statusClass = 'secondary';
                let statusText = 'Sem dados';
                
                if (item.interval_roi > 0) {
                    if (item.interval_roi >= 2.5) {
                        statusClass = 'success';
                        statusText = 'Excelente';
                    } else if (item.interval_roi >= 2.0) {
                        statusClass = 'warning';
                        statusText = 'Bom';
                    } else if (item.interval_roi >= 1.5) {
                        statusClass = 'info';
                        statusText = 'Regular';
                    } else {
                        statusClass = 'danger';
                        statusText = 'Atenção';
                    }
                }
                
                // Adicionar classe especial para linha mais recente
                if (index === 0) {
                    row.classList.add('cumulative-row');
                }
                
                const time = new Date(item.timestamp);
                const timeStr = time.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <td><strong>${timeStr}</strong></td>
                    <td>R$ ${item.interval_spend.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${item.interval_sales.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td><strong>${item.interval_roi.toFixed(2)}</strong></td>
                    <td><strong>R$ ${item.day_spend.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                    <td><strong>R$ ${item.day_sales.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                    <td><strong class="text-primary">${item.day_roi.toFixed(2)}</strong></td>
                    <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updateDayMetrics(data) {
            if (data.length === 0) return;
            
            const latestData = data[data.length - 1]; // Dados mais recentes
            
            document.getElementById('day-roi').textContent = latestData.day_roi.toFixed(2);
            document.getElementById('day-sales').textContent = 
                'R$ ' + latestData.day_sales.toLocaleString('pt-BR');
            document.getElementById('day-spend').textContent = 
                'R$ ' + latestData.day_spend.toLocaleString('pt-BR');
            
            // Calcular lucro e margem
            const profit = latestData.day_sales - latestData.day_spend;
            const margin = latestData.day_sales > 0 ? (profit / latestData.day_sales * 100) : 0;
            
            document.getElementById('day-profit').textContent = 
                'R$ ' + profit.toLocaleString('pt-BR');
            document.getElementById('day-margin').textContent = margin.toFixed(1) + '%';
            
            // Última hora
            document.getElementById('last-hour-sales').textContent = 
                'R$ ' + latestData.interval_sales.toLocaleString('pt-BR');
        }

        function updateHourlyChart(data) {
            const ctx = document.getElementById('hourlyEvolutionChart').getContext('2d');
            
            if (hourlyChart) {
                hourlyChart.destroy();
            }
            
            const labels = data.map(item => {
                const time = new Date(item.timestamp);
                return time.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            });
            
            const roiCumulativeData = data.map(item => item.day_roi);
            const salesCumulativeData = data.map(item => item.day_sales);
            const spendCumulativeData = data.map(item => item.day_spend);
            
            hourlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ROI Acumulativo',
                            data: roiCumulativeData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            borderWidth: 3
                        },
                        {
                            label: 'Vendas Acumuladas (R$)',
                            data: salesCumulativeData,
                            borderColor: '#28a745',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1',
                            borderWidth: 2
                        },
                        {
                            label: 'Gasto Acumulado (R$)',
                            data: spendCumulativeData,
                            borderColor: '#fd7e14',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'ROI Acumulativo' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Valor Acumulado (R$)' },
                            grid: { drawOnChartArea: false },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('pt-BR');
            document.getElementById('campaign-date').textContent = now.toLocaleDateString('pt-BR');
        }

        function refreshData() {
            document.getElementById('hourly-table').innerHTML = 
                '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Atualizando...</td></tr>';
            
            setTimeout(() => {
                loadHourlyData();
            }, 1000);
        }

        function exportData() {
            // Implementar exportação dos dados
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Período,Gasto Intervalo,Vendas Intervalo,ROI Intervalo,Gasto Acumulado,Vendas Acumuladas,ROI Acumulado\n"
                + hourlyData.map(item => 
                    `${item.period},${item.interval_spend},${item.interval_sales},${item.interval_roi},${item.day_spend},${item.day_sales},${item.day_roi}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `roi_hourly_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadHourlyData();
            
            // Atualizar a cada 30 segundos
            setInterval(() => {
                loadHourlyData();
            }, 30000);
        });
    </script>
</body>
</html>