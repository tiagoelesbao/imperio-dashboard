<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações - ROI Império</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background-color: #2c3e50;
            min-height: 100vh;
            padding: 0;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 15px 20px;
            border-radius: 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            background-color: #34495e;
            color: #fff;
        }
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: #fff;
        }
        .main-content {
            padding: 30px;
        }
        .config-card {
            border: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="text-center py-4">
                    <h5 class="text-white">
                        <i class="fas fa-chart-line"></i> ROI Império
                    </h5>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-dashboard me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/config">
                            <i class="fas fa-cog me-2"></i>Configurações
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/campaigns">
                            <i class="fas fa-bullhorn me-2"></i>Campanhas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/affiliates">
                            <i class="fas fa-users me-2"></i>Afiliados
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/facebook">
                            <i class="fab fa-facebook me-2"></i>Facebook Ads
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">
                            <i class="fas fa-history me-2"></i>Histórico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">
                            <i class="fas fa-chart-bar me-2"></i>Análises
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <h2 class="mb-4">
                    <i class="fas fa-cog me-2"></i>Configurações do Sistema
                </h2>
                
                <!-- Config Card -->
                <div class="card config-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Configuração da Ação</h5>
                        
                        <form id="configForm">
                            <div class="mb-3">
                                <label for="productId" class="form-label">
                                    <i class="fas fa-key me-1"></i>ID da Ação/Produto
                                </label>
                                <input type="text" class="form-control" id="productId" 
                                       value="{{ product_id }}" placeholder="Ex: 684c73283d75820c0a77a42f">
                                <small class="form-text text-muted">
                                    ID único da ação para monitoramento de ROI
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="campaignName" class="form-label">
                                    <i class="fas fa-tag me-1"></i>Nome da Campanha
                                </label>
                                <input type="text" class="form-control" id="campaignName" 
                                       value="{{ campaign_name }}" placeholder="Ex: Sorteio 200mil">
                            </div>
                            
                            <div class="mb-3">
                                <label for="roiGoal" class="form-label">
                                    <i class="fas fa-bullseye me-1"></i>Meta de ROI
                                </label>
                                <input type="number" class="form-control" id="roiGoal" 
                                       value="{{ roi_goal }}" step="0.01" placeholder="Ex: 2.00">
                            </div>
                            
                            <div class="mb-3">
                                <label for="dailyBudget" class="form-label">
                                    <i class="fas fa-dollar-sign me-1"></i>Orçamento Diário
                                </label>
                                <input type="number" class="form-control" id="dailyBudget" 
                                       value="{{ daily_budget }}" step="0.01" placeholder="Ex: 10000.00">
                            </div>
                            
                            <div class="mb-3">
                                <label for="collectionInterval" class="form-label">
                                    <i class="fas fa-clock me-1"></i>Intervalo de Coleta (minutos)
                                </label>
                                <select class="form-control" id="collectionInterval">
                                    <option value="15">15 minutos</option>
                                    <option value="30" selected>30 minutos</option>
                                    <option value="60">60 minutos</option>
                                </select>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="mb-3">Contas Facebook Ads</h5>
                            <div id="facebookAccounts">
                                {% for account in facebook_accounts %}
                                <div class="input-group mb-2">
                                    <span class="input-group-text">
                                        <i class="fab fa-facebook"></i>
                                    </span>
                                    <input type="text" class="form-control fb-account" 
                                           value="{{ account }}" placeholder="act_xxxxx">
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="addFacebookAccount()">
                                <i class="fas fa-plus me-1"></i>Adicionar Conta
                            </button>
                            
                            <hr class="my-4">
                            
                            <h5 class="mb-3">Mapeamento de Contas por Canal</h5>
                            <p class="text-muted mb-3">Configure qual conta do Facebook está anunciando para cada canal específico:</p>
                            
                            <div id="channelMapping">
                                <!-- Instagram Channel -->
                                <div class="card mb-3">
                                    <div class="card-header bg-success text-white">
                                        <i class="fab fa-instagram me-2"></i>Instagram
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {% for account in facebook_accounts %}
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input channel-mapping" type="checkbox" 
                                                           value="{{ account }}" 
                                                           data-channel="instagram"
                                                           id="instagram_{{ account }}"
                                                           {% if account in channel_mapping.get('instagram', []) %}checked{% endif %}>
                                                    <label class="form-check-label" for="instagram_{{ account }}">
                                                        {{ account }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Groups Channel -->
                                <div class="card mb-3">
                                    <div class="card-header bg-warning text-dark">
                                        <i class="fab fa-whatsapp me-2"></i>Grupos WhatsApp
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {% for account in facebook_accounts %}
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input channel-mapping" type="checkbox" 
                                                           value="{{ account }}" 
                                                           data-channel="grupos"
                                                           id="grupos_{{ account }}"
                                                           {% if account in channel_mapping.get('grupos', []) %}checked{% endif %}>
                                                    <label class="form-check-label" for="grupos_{{ account }}">
                                                        {{ account }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- General Channel -->
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-globe me-2"></i>Geral (Outros)
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {% for account in facebook_accounts %}
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input channel-mapping" type="checkbox" 
                                                           value="{{ account }}" 
                                                           data-channel="geral"
                                                           id="geral_{{ account }}"
                                                           {% if not channel_mapping or account in channel_mapping.get('geral', facebook_accounts) %}checked{% endif %}>
                                                    <label class="form-check-label" for="geral_{{ account }}">
                                                        {{ account }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="mb-3">Códigos de Afiliados</h5>
                            <div class="mb-2">
                                <label class="form-label">Instagram</label>
                                <input type="text" class="form-control" id="affiliateInstagram" 
                                       value="{{ affiliate_instagram }}" placeholder="Ex: L8UTEDVTI0">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Grupo 1</label>
                                <input type="text" class="form-control" id="affiliateGrupo1" 
                                       value="{{ affiliate_grupo1 }}" placeholder="Ex: 17QB25AKRL">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Grupo 2</label>
                                <input type="text" class="form-control" id="affiliateGrupo2" 
                                       value="" placeholder="REMOVIDO - Não existe mais" disabled>
                                <small class="text-muted">Este afiliado foi descontinuado</small>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Salvar Configurações
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="window.location.href='/'">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Status Card -->
                <div class="card config-card mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Status do Sistema</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Coleta Automática:</strong> 
                                    <span class="badge bg-success">Ativa</span>
                                </p>
                                <p><strong>Próxima Coleta:</strong> 
                                    <span id="nextCollection">--</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total de Coletas Hoje:</strong> 
                                    <span id="collectionsToday">0</span>
                                </p>
                                <p><strong>Última Coleta:</strong> 
                                    <span id="lastCollection">--</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function addFacebookAccount() {
            const container = document.getElementById('facebookAccounts');
            const newInput = document.createElement('div');
            newInput.className = 'input-group mb-2';
            newInput.innerHTML = `
                <span class="input-group-text">
                    <i class="fab fa-facebook"></i>
                </span>
                <input type="text" class="form-control fb-account" placeholder="act_xxxxx">
                <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newInput);
        }
        
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fbAccounts = Array.from(document.querySelectorAll('.fb-account'))
                                   .map(input => input.value)
                                   .filter(value => value.trim() !== '');
            
            // Collect channel mapping data
            const channelMapping = {};
            const mappingInputs = document.querySelectorAll('.channel-mapping:checked');
            mappingInputs.forEach(input => {
                const channel = input.dataset.channel;
                const account = input.value;
                
                if (!channelMapping[channel]) {
                    channelMapping[channel] = [];
                }
                channelMapping[channel].push(account);
            });
            
            const configData = {
                product_id: document.getElementById('productId').value,
                campaign_name: document.getElementById('campaignName').value,
                roi_goal: parseFloat(document.getElementById('roiGoal').value),
                daily_budget: parseFloat(document.getElementById('dailyBudget').value),
                collection_interval: parseInt(document.getElementById('collectionInterval').value),
                facebook_accounts: fbAccounts,
                channel_mapping: channelMapping,
                affiliates: {
                    instagram: document.getElementById('affiliateInstagram').value,
                    grupo1: document.getElementById('affiliateGrupo1').value,
                    grupo2: document.getElementById('affiliateGrupo2').value
                }
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                if (response.ok) {
                    alert('Configurações salvas com sucesso!');
                    window.location.href = '/';
                } else {
                    alert('Erro ao salvar configurações');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar configurações');
            }
        });
        
        // Carregar status
        async function loadStatus() {
            try {
                const response = await fetch('/api/collection/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const status = data.data;
                    document.getElementById('collectionsToday').textContent = status.today_collections;
                    document.getElementById('lastCollection').textContent = 
                        status.last_collection ? new Date(status.last_collection).toLocaleString('pt-BR') : '--';
                    
                    // Calcular próxima coleta
                    if (status.last_collection) {
                        const interval = parseInt(document.getElementById('collectionInterval').value);
                        const lastTime = new Date(status.last_collection);
                        const nextTime = new Date(lastTime.getTime() + interval * 60000);
                        document.getElementById('nextCollection').textContent = nextTime.toLocaleTimeString('pt-BR');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar status:', error);
            }
        }
        
        // Carregar status ao abrir a página
        loadStatus();
        
        // Atualizar a cada 30 segundos
        setInterval(loadStatus, 30000);
    </script>
</body>
</html>