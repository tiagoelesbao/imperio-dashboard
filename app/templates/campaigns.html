<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campanhas - ROI Império</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background-color: #2c3e50;
            min-height: 100vh;
            padding: 0;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 15px 20px;
            border-radius: 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            background-color: #34495e;
            color: #fff;
        }
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: #fff;
        }
        .campaign-card {
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 15px;
            transition: transform 0.3s;
        }
        .campaign-card:hover {
            transform: translateY(-5px);
        }
        .campaign-rank {
            position: absolute;
            top: -10px;
            left: -10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .profit-positive { color: #28a745; }
        .profit-negative { color: #dc3545; }
        .roi-good { background-color: #d4edda; color: #155724; }
        .roi-warning { background-color: #fff3cd; color: #856404; }
        .roi-danger { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="text-center py-4">
                    <h5 class="text-white">
                        <i class="fas fa-chart-line"></i> ROI Império
                    </h5>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-dashboard me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/config">
                            <i class="fas fa-cog me-2"></i>Configurações
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/campaigns">
                            <i class="fas fa-bullhorn me-2"></i>Campanhas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/affiliates">
                            <i class="fas fa-users me-2"></i>Afiliados
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/facebook">
                            <i class="fab fa-facebook me-2"></i>Facebook Ads
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">
                            <i class="fas fa-history me-2"></i>Histórico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">
                            <i class="fas fa-chart-bar me-2"></i>Análises
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 py-4" style="background-color: #f8f9fa;">
                <!-- Header -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1 class="h2 mb-1">
                                    <i class="fas fa-bullhorn text-primary me-2"></i>
                                    Campanhas Ativas - Ranking por Lucro
                                </h1>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-trophy me-1"></i>
                                    Campanhas ordenadas por performance de lucro
                                </p>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-primary" onclick="refreshCampaigns()">
                                    <i class="fas fa-refresh me-1"></i>Atualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <label class="form-label">Filtrar por Canal:</label>
                                        <select class="form-select" id="channelFilter">
                                            <option value="">Todos os Canais</option>
                                            <option value="geral">Geral</option>
                                            <option value="instagram">Instagram</option>
                                            <option value="grupos">Grupos</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Período:</label>
                                        <select class="form-select" id="periodFilter">
                                            <option value="today">Hoje</option>
                                            <option value="yesterday">Ontem</option>
                                            <option value="7days">Últimos 7 dias</option>
                                            <option value="30days">Últimos 30 dias</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Status:</label>
                                        <select class="form-select" id="statusFilter">
                                            <option value="">Todos</option>
                                            <option value="active">Ativas</option>
                                            <option value="paused">Pausadas</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                                            <i class="fas fa-filter me-1"></i>Filtrar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            <div class="card-body text-center">
                                <i class="fas fa-bullhorn fa-2x mb-2"></i>
                                <div class="h4" id="totalCampaigns">0</div>
                                <small>Campanhas Ativas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-white" style="background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%);">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                <div class="h4" id="totalProfit">R$ 0</div>
                                <small>Lucro Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-white" style="background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);">
                            <div class="card-body text-center">
                                <i class="fas fa-percentage fa-2x mb-2"></i>
                                <div class="h4" id="averageROI">0.00</div>
                                <small>ROI Médio</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-white" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                <div class="h4" id="totalSpend">R$ 0</div>
                                <small>Gasto Total</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaigns List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-trophy me-2"></i>Ranking de Campanhas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="campaignsList">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                        <p class="text-muted mt-2">Carregando campanhas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let realCampaigns = [];

        async function loadRealCampaigns(period = 'today', channelFilter = '', statusFilter = '') {
            try {
                // Construir URL com parâmetros
                const params = new URLSearchParams({
                    period: period,
                    channel_filter: channelFilter,
                    status_filter: statusFilter
                });
                
                const response = await fetch(`/api/campaigns/real?${params.toString()}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    realCampaigns = data.campaigns;
                    const summary = data.summary;
                    const filters = data.filters;
                    
                    // Atualizar cards de resumo com dados reais
                    updateSummaryCardsReal(summary, filters);
                    renderCampaignsList(realCampaigns);
                    
                    // Atualizar título com período selecionado
                    updatePageTitle(filters.period_label);
                } else {
                    console.error('Erro ao carregar campanhas:', data.message);
                    showError('Erro ao carregar dados das campanhas');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                showError('Erro de conexão com o servidor');
            }
        }

        function updateSummaryCardsReal(summary, filters) {
            document.getElementById('totalCampaigns').textContent = summary.total_campaigns || 0;
            document.getElementById('totalProfit').textContent = 'R$ ' + (summary.total_profit || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('totalSpend').textContent = 'R$ ' + (summary.total_spend || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('averageROI').textContent = (summary.average_roi || 0).toFixed(2);
        }
        
        function updatePageTitle(periodLabel) {
            const titleElement = document.querySelector('h1.h2');
            if (titleElement) {
                titleElement.innerHTML = `
                    <i class="fas fa-bullhorn text-primary me-2"></i>
                    Campanhas Ativas - Ranking por Lucro - ${periodLabel}
                `;
            }
        }

        function showError(message) {
            const container = document.getElementById('campaignsList');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">${message}</h5>
                    <button class="btn btn-primary mt-2" onclick="loadRealCampaigns()">
                        <i class="fas fa-refresh me-1"></i>Tentar Novamente
                    </button>
                </div>
            `;
        }

        function loadCampaigns() {
            loadRealCampaigns();
        }

        function updateSummaryCards(campaigns) {
            const totalCampaigns = campaigns.length;
            const totalProfit = campaigns.reduce((sum, c) => sum + c.profit, 0);
            const totalSpend = campaigns.reduce((sum, c) => sum + c.spend, 0);
            const averageROI = campaigns.reduce((sum, c) => sum + c.roi, 0) / campaigns.length;

            document.getElementById('totalCampaigns').textContent = totalCampaigns;
            document.getElementById('totalProfit').textContent = 'R$ ' + totalProfit.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('totalSpend').textContent = 'R$ ' + totalSpend.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('averageROI').textContent = averageROI.toFixed(2);
        }

        function renderCampaignsList(campaigns) {
            const container = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma campanha encontrada</h5>
                        <p class="text-muted">Ajuste os filtros ou verifique se há campanhas ativas.</p>
                    </div>
                `;
                return;
            }

            const campaignsHtml = campaigns.map((campaign, index) => {
                const rank = index + 1;
                const roiClass = campaign.roi >= 2 ? 'roi-good' : campaign.roi >= 1.5 ? 'roi-warning' : 'roi-danger';
                const profitClass = campaign.profit > 0 ? 'profit-positive' : 'profit-negative';
                const channelIcon = getChannelIcon(campaign.channel);
                const channelColor = getChannelColor(campaign.channel);


                return `
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="campaign-card card h-100 position-relative">
                            <div class="campaign-rank">${rank}</div>
                            <div class="card-header" style="background-color: ${channelColor}; color: white;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="${channelIcon} me-1"></i>
                                        ${campaign.channel.charAt(0).toUpperCase() + campaign.channel.slice(1)}
                                    </h6>
                                    <span class="badge bg-light text-dark">${campaign.status}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title" title="${campaign.name}">${campaign.name}</h6>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Lucro</small>
                                        <div class="h5 ${profitClass} mb-0">
                                            R$ ${campaign.profit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">ROI</small>
                                        <div class="h5 mb-0">
                                            <span class="badge ${roiClass}">${campaign.roi.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Gasto</small>
                                        <div class="fw-bold">R$ ${campaign.spend.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Receita</small>
                                        <div class="fw-bold">R$ ${campaign.revenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-4">
                                        <small class="text-muted">Impressões</small>
                                        <div class="small fw-bold">${campaign.impressions.toLocaleString('pt-BR')}</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Cliques</small>
                                        <div class="small fw-bold">${campaign.clicks.toLocaleString('pt-BR')}</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Conversões</small>
                                        <div class="small fw-bold">${campaign.conversions}</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-12">
                                            <small class="text-muted">Orçamento Atual:</small>
                                            <div class="mt-1">
                                                <span class="badge bg-success fs-6">
                                                    R$ ${campaign.budget.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="row">${campaignsHtml}</div>`;
        }

        function getChannelIcon(channel) {
            switch(channel) {
                case 'instagram': return 'fab fa-instagram';
                case 'grupos': return 'fab fa-whatsapp';
                case 'geral': return 'fas fa-globe';
                default: return 'fas fa-bullhorn';
            }
        }

        function getChannelColor(channel) {
            switch(channel) {
                case 'instagram': return '#E4405F';
                case 'grupos': return '#25D366';
                case 'geral': return '#007bff';
                default: return '#6c757d';
            }
        }


        function applyFilters() {
            const channelFilter = document.getElementById('channelFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            // Recarregar dados com filtros aplicados via API
            loadRealCampaigns(periodFilter, channelFilter, statusFilter);
        }

        function refreshCampaigns() {
            document.getElementById('campaignsList').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="text-muted mt-2">Atualizando campanhas...</p>
                </div>
            `;
            
            // Obter filtros atuais e recarregar dados
            const channelFilter = document.getElementById('channelFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            loadRealCampaigns(periodFilter, channelFilter, statusFilter);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCampaigns();
        });
    </script>
</body>
</html>